{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard ‚Äì Event Management Suite{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="{% static 'core/css/dashboard.css' %}">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="user-dashboard">
    <div class="welcome-banner">
        <div class="banner-content">
            <h1>Welcome back, {{ user.first_name|default:user.username }}!</h1>
            <p>Here's your summary for today, {% now "F j, Y" %}.</p>
        </div>
    </div>

    <nav class="nav-tabs">
        <div class="nav-content">
            <button class="nav-tab active" data-tab="overview"><i class="fas fa-chart-line"></i> <span>Overview</span></button>
            <button class="nav-tab" data-tab="events"><i class="fas fa-calendar-alt"></i> <span>My Events</span></button>
            {% if not request.session.role or request.session.role != 'student' %}
            <button class="nav-tab" data-tab="students"><i class="fas fa-user-graduate"></i> <span>My Students</span></button>
            {% endif %}
            <button class="nav-tab" data-tab="profile"><i class="fas fa-user-circle"></i> <span>My Profile</span></button>

            {% if user.is_superuser %}
            <a href="/admin/" class="nav-tab"><i class="fas fa-cogs"></i> <span>Admin</span></a>
            {% endif %}
        </div>
    </nav>

    <main class="main-content">
        <div id="overview" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card blue" id="dashboardUpcomingEvents">
                    <div class="stat-content">
                        <div class="stat-text">
                            <p class="stat-label">Upcoming Events</p>
                            <ul class="upcoming-events-list" style="list-style:none; margin:0; padding:0;">
                                {% for event in user.upcoming_events %}
                                <li>
                                    <button class="event-link" type="button" data-action="view-event-details" data-event-id="{{ event.id }}" style="background:none; border:none; color:#2c5aa0; text-align:left; font-weight:500; cursor:pointer; padding:0;">
                                        {{ event.event_title }} <span style="color:#888; font-size:0.95em;">({{ event.event_datetime|date:'M d, Y H:i' }})</span>
                                    </button>
                                </li>
                                {% empty %}
                                <li style="color:#888;">No upcoming events.</li>
                                {% endfor %}
                            </ul>
                        </div>
                        <i class="fas fa-calendar stat-icon"></i>
                    </div>
                </div>
            </div>
            {% if not request.session.role or request.session.role != 'student' %}
            <div class="mentees-section">
                <h3>My Top Mentees</h3>
                <div class="mentees-list">
                    <div class="mentee-item">
                        <div class="mentee-avatar">SD</div>
                        <div class="mentee-info">
                            <h4>S. Devkrishna</h4>
                            <p>GPA: 8.5 | Attendance: 92%</p>
                            <span>Last meeting: 2 days ago</span>
                        </div>
                    </div>
                    <div class="mentee-item">
                        <div class="mentee-avatar">AG</div>
                        <div class="mentee-info">
                            <h4>Arisha Gupta</h4>
                            <p>GPA: 9.2 | Attendance: 96%</p>
                            <span>Last meeting: 1 week ago</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="charts-row">
                <div class="chart-card">
                    <h3>Event Contribution</h3>
                    {% if user.role_assignments.count > 1 %}
                        <div class="pie-chart-info">
                            <p>Your contributions by organization:</p>
                            <ul>
                                {% for ra in user.role_assignments.all %}
                                    <li><strong>{{ ra.organization.name }}</strong>: {{ ra.contribution_percent|default:'0%' }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% else %}
                        <div class="pie-chart-info">
                            <p>Your contribution in <strong>{{ user.role_assignments.first.organization.name }}</strong>:</p>
                            <p class="pie-total">{{ user.role_assignments.first.contribution_percent|default:'0%' }}</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div id="events" class="tab-content">
            <div class="stats-row" style="display: flex; gap: 24px; margin-bottom: 24px;">
                <div class="stat-card blue clickable" id="cardUpcoming" style="flex: 1;">
                    <div class="stat-center">
                        <i class="fas fa-calendar stat-icon-large"></i>
                        <div class="stat-label">Upcoming Events</div>
                        <div class="stat-number">{{ upcoming_events_count }}</div>
                    </div>
                </div>
                <div class="stat-card green clickable" id="cardOrganized" style="flex: 1;">
                    <div class="stat-center">
                        <i class="fas fa-target stat-icon-large"></i>
                        <div class="stat-label">Organized Events</div>
                        <div class="stat-number">{{ organized_events_count }}</div>
                    </div>
                </div>
                <div class="stat-card purple" style="flex: 1;">
                    <div class="stat-center">
                        <i class="fas fa-users stat-icon-large"></i>
                        <div class="stat-label">Students Participated</div>
                        <div class="stat-number">{{ students_participated }}</div>
                    </div>
                </div>
                <div class="stat-card orange clickable" id="cardThisWeek" style="flex: 1;">
                    <div class="stat-center">
                        <i class="fas fa-calendar-week stat-icon-large"></i>
                        <div class="stat-label">This Week</div>
                        <div class="stat-number">{{ this_week_events }}</div>
                    </div>
                </div>
            </div>
            
            <div class="dashboard-events-bottom" style="display: flex; gap: 32px; align-items: flex-start; margin-top: 24px;">
                <div class="dashboard-events-left" style="flex: 1; min-width: 0;">
                    <div class="filters-section">
                        <div class="filters-content">
                            <div class="filter-label"><i class="fas fa-filter"></i><span>Filters:</span></div>
                            <select class="filter-select" id="eventTypeFilter"><option value="">All Events</option><option value="my">My Events</option><option value="department">Department Events</option></select>
                            <select class="filter-select" id="eventTimeFilter"><option value="">This Month</option><option value="week">This Week</option><option value="next_month">Next Month</option></select>
                            <select class="filter-select" id="eventRoleFilter"><option value="">All Roles</option><option value="organizer">Organizer</option><option value="coordinator">Coordinator</option><option value="faculty_advisor">Faculty Advisor</option></select>
                        </div>
                    </div>
                    <div class="events-section" style="margin-top: 24px;">
                        <div class="section-header">
                            <h3>My Events</h3>
                            <a class="btn-primary" href="/suite/submit/">
                              <i class="fas fa-plus"></i> Create Event
                            </a>
                        </div>
                        <div class="events-list" id="myEventsList">
                          {% for event in my_events %}
                            <div class="event-item" data-event-type="my" data-event-role="{{ event.user_type|default:'organizer' }}" data-event-time="{{ event.event_datetime|date:'Y-m' }}">
                                <div class="event-content">
                                    <h4>{{ event.event_title }}</h4>
                                    <div class="event-details">
                                        <span>üìç {{ event.event_datetime|date:"M d, Y H:i" }}</span>
                                        <span>üë§ {{ event.submitted_by.get_full_name }}</span>
                                        <span>üë• {{ event.fest_fee_participants|default:event.conf_fee_participants }}</span>
                                    </div>
                                </div>
                                <div class="event-actions">
                                    <span class="status-badge {{ event.status|lower }}">{{ event.get_status_display }}</span>
                                    <button class="btn-icon" type="button" data-action="edit-event" data-event-id="{{ event.id }}"><i class="fas fa-edit"></i></button>
                                </div>
                            </div>
                          {% empty %}
                            <div class="empty-state">No events found.</div>
                          {% endfor %}
                        </div>
                    </div>
                    <div class="university-events" style="margin-top: 24px;">
                        <h3>üèõÔ∏è Other University Events</h3>
                        <div class="university-events-list" id="otherEventsList">
                          {% for event in other_events %}
                            <div class="university-event" data-event-type="other" data-event-role="{{ event.user_type|default:'organizer' }}" data-event-time="{{ event.event_datetime|date:'Y-m' }}">
                                <div class="event-row" style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                                    <div style="display: flex; flex-direction: column;">
                                        <span class="event-title" style="font-weight: 600;">{{ event.event_title }}</span>
                                        <span class="event-dept" style="color: #888; font-size: 0.95em;">{% if event.organization %}{{ event.organization.name }}{% else %}N/A{% endif %}</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 1.5em;">
                                        <span style="font-size: 1em; color: #555;">{{ event.event_datetime|date:"M d" }}</span>
                                        <button class="btn-link" type="button" data-action="view-event-details" data-event-id="{{ event.id }}">View Details</button>
                                    </div>
                                </div>
                            </div>
                          {% empty %}
                            <div class="empty-state">No university events found.</div>
                          {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="dashboard-events-right" style="flex: 1; min-width: 0;">
                    {% include 'core/proposal_status.html' %}
                </div>
            </div>
        </div>

        {% if not request.session.role or request.session.role != 'student' %}
        <div id="students" class="tab-content">
            <div class="search-section">
                <div class="search-content">
                    <div class="search-input">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" placeholder="Search students..." id="studentSearch">
                    </div>
                    <select class="filter-select" id="studentStatusFilter"><option value="">All Students</option><option value="need_checkin">Need Check-in</option><option value="doing_well">Doing Well</option></select>
                    <select class="filter-select" id="studentDeptFilter"><option value="">All Departments</option><option value="cs">Computer Science</option><option value="ece">Electronics</option><option value="me">Mechanical</option></select>
                </div>
            </div>

            <div class="students-section">
                <div class="section-header">
                    <h3>My Students</h3>
                    <button class="btn-primary" type="button" data-action="add-student">
                        <i class="fas fa-plus"></i> Add Student
                    </button>
                </div>
                <div class="students-list">
                    <div class="student-item" data-action="show-student-profile" data-student-id="1">
                        <div class="student-left">
                            <div class="student-avatar">SD</div>
                            <div class="student-info">
                                <h4>S. Devkrishna</h4>
                                <p class="student-reg">23112015 | 25 interactions</p>
                                <div class="student-stats">
                                    <span>üìä GPA: 8.5</span>
                                    <span>üìÖ Attendance: 92%</span>
                                    <span>üéØ Last meeting: 2 days ago</span>
                                </div>
                            </div>
                        </div>
                        <div class="student-actions">
                            <span class="status-badge warning">‚ö†Ô∏è Needs check-in</span>
                            <button class="btn-icon" type="button" data-action="message-student" data-student-id="1"><i class="fas fa-comment"></i></button>
                            <button class="btn-icon" type="button" data-action="call-student" data-student-id="1"><i class="fas fa-phone"></i></button>
                        </div>
                    </div>
                    <div class="student-item" data-action="show-student-profile" data-student-id="2">
                        <div class="student-left">
                            <div class="student-avatar">AG</div>
                            <div class="student-info">
                                <h4>Arisha Gupta</h4>
                                <p class="student-reg">23112002 | 14 interactions</p>
                                <div class="student-stats">
                                    <span>üìä GPA: 9.2</span>
                                    <span>üìÖ Attendance: 96%</span>
                                    <span>üéØ Last meeting: 1 week ago</span>
                                </div>
                            </div>
                        </div>
                        <div class="student-actions">
                            <span class="status-badge success">‚úÖ Doing well</span>
                            <button class="btn-icon" type="button" data-action="message-student" data-student-id="2"><i class="fas fa-comment"></i></button>
                            <button class="btn-icon" type="button" data-action="call-student" data-student-id="2"><i class="fas fa-phone"></i></button>
                        </div>
                    </div>
                    <div class="student-item" data-action="show-student-profile" data-student-id="3">
                        <div class="student-left">
                            <div class="student-avatar">RK</div>
                            <div class="student-info">
                                <h4>Rohit Kumar</h4>
                                <p class="student-reg">23112025 | 18 interactions</p>
                                <div class="student-stats">
                                    <span>üìä GPA: 7.8</span>
                                    <span>üìÖ Attendance: 88%</span>
                                    <span>üéØ Last meeting: 5 days ago</span>
                                </div>
                            </div>
                        </div>
                        <div class="student-actions">
                            <span class="status-badge warning">‚ö†Ô∏è Needs attention</span>
                            <button class="btn-icon" type="button" data-action="message-student" data-student-id="3"><i class="fas fa-comment"></i></button>
                            <button class="btn-icon" type="button" data-action="call-student" data-student-id="3"><i class="fas fa-phone"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div id="profile" class="tab-content">
            <div class="profile-section">
                <div class="profile-header">
                    <div class="profile-left">
                        <div class="profile-avatar-large">
                            {% if user.first_name %}
                                {{ user.first_name.0|upper }}{% if user.last_name %}{{ user.last_name.0|upper }}{% endif %}
                            {% else %}
                                {{ user.username.0|upper }}
                            {% endif %}
                        </div>
                        <div class="profile-info">
                            <h2>{{ user.get_full_name|default:user.username }}</h2>
                            <p>{{ user.email }}</p>
                            {% if user.role_assignments.exists %}
                              <p>
                                {% for ra in user.role_assignments.all %}
                                  {{ ra.organization.name }} &bull; {{ ra.role.name }}<br>
                                {% endfor %}
                              </p>
                            {% else %}
                              <p>No organization/role assigned.</p>
                            {% endif %}
                        </div>
                    </div>
                    </div>
            </div>

            <div class="classes-section">
                <h3>üìö My Classes</h3>
                <div class="classes-list">
                    <div class="class-item">
                        <div>
                            <p class="class-name">CS101 - Programming Fundamentals</p>
                            <p class="class-students">45 students</p>
                        </div>
                        <button class="btn-link" type="button" data-action="view-class-details" data-class-id="1">View Details</button>
                    </div>
                    <div class="class-item">
                        <div>
                            <p class="class-name">CS301 - Data Structures</p>
                            <p class="class-students">32 students</p>
                        </div>
                        <button class="btn-link" type="button" data-action="view-class-details" data-class-id="2">View Details</button>
                    </div>
                    <div class="class-item">
                        <div>
                            <p class="class-name">CS401 - Database Systems</p>
                            <p class="class-students">28 students</p>
                        </div>
                        <button class="btn-link" type="button" data-action="view-class-details" data-class-id="3">View Details</button>
                    </div>
                </div>
            </div>

            <div class="profile-grid">
                <div class="achievements-section">
                    <div class="section-header">
                        <h3>üèÜ My Achievements</h3>
                        <button class="btn-icon" type="button" data-action="add-achievement"><i class="fas fa-plus"></i></button>
                    </div>
                    <div class="achievements-list">
                        <div class="achievement-item">Best Faculty Award 2024</div>
                        <div class="achievement-item">Research Publication - AI in Education</div>
                        <div class="achievement-item">15 years of teaching experience</div>
                        <div class="achievement-item">Department Innovation Award</div>
                    </div>
                </div>

                <div class="goals-section">
                    <div class="section-header">
                        <h3>üéØ Current Goals</h3>
                        <button class="btn-icon" type="button" data-action="add-goal"><i class="fas fa-plus"></i></button>
                    </div>
                    <div class="goals-list">
                        <div class="goal-item">
                            <p class="goal-text">Complete 10 LORs this month</p>
                            <div class="goal-progress">
                                <div class="progress-bar"><div class="progress-fill" style="width: 80%"></div></div>
                                <span class="progress-text">80%</span>
                            </div>
                        </div>
                        <div class="goal-item">
                            <p class="goal-text">Organize Tech Symposium</p>
                            <div class="goal-progress">
                                <div class="progress-bar"><div class="progress-fill" style="width: 70%"></div></div>
                                <span class="progress-text">70%</span>
                            </div>
                        </div>
                        <div class="goal-item">
                            <p class="goal-text">Publish Research Paper</p>
                            <div class="goal-progress">
                                <div class="progress-bar"><div class="progress-fill" style="width: 45%"></div></div>
                                <span class="progress-text">45%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="timeline-section">
                <h3>üìÖ This Year's Contributions</h3>
                <div class="timeline">
                    <div class="timeline-item completed"><div class="timeline-dot"></div><div class="timeline-content"><h4>January</h4><p>Organized New Student Orientation</p><span class="timeline-status">completed</span></div></div>
                    <div class="timeline-item completed"><div class="timeline-dot"></div><div class="timeline-content"><h4>February</h4><p>Research Paper Submission</p><span class="timeline-status">completed</span></div></div>
                    <div class="timeline-item ongoing"><div class="timeline-dot"></div><div class="timeline-content"><h4>March</h4><p>Coordinating Tech Symposium</p><span class="timeline-status">ongoing</span></div></div>
                    <div class="timeline-item planned"><div class="timeline-dot"></div><div class="timeline-content"><h4>April</h4><p>Student Career Guidance Workshop</p><span class="timeline-status">planned</span></div></div>
                </div>
            </div>
        </div>
    </main>
</div>

<div id="dashboardModal" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close" data-action="close-modal">&times;</button>
        <h3 id="modalTitle"></h3>
        <div id="modalBody"></div>
    </div>
</div>

<div id="globalSearchModal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <button class="modal-close" type="button" onclick="document.getElementById('globalSearchModal').style.display='none'">&times;</button>
        <h3>Search Results</h3>
        <div id="globalSearchResults"></div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
  window.USER_ORG_NAME = "{{ user.role_assignments.first.organization.name|default:'' }}";

  // Global Search JS
  document.addEventListener('DOMContentLoaded', function() {
    var input = document.getElementById('globalSearchInput');
    var btn = document.getElementById('globalSearchBtn');
    var modal = document.getElementById('globalSearchModal');
    var resultsDiv = document.getElementById('globalSearchResults');
    function showResults(results) {
      resultsDiv.innerHTML = '';
      if (!results.length) {
        resultsDiv.innerHTML = '<div style="color:#888;">No results found.</div>';
        return;
      }
      var html = '<ul style="list-style:none; padding:0;">';
      results.forEach(function(item) {
        html += '<li style="margin-bottom:12px;">' + item + '</li>';
      });
      html += '</ul>';
      resultsDiv.innerHTML = html;
    }
    function searchAll(query) {
      query = query.trim().toLowerCase();
      var results = [];
      // Search events
      document.querySelectorAll('.event-item, .university-event').forEach(function(ev) {
        var title = ev.querySelector('h4, .event-title');
        if (title && title.textContent.toLowerCase().includes(query)) {
          results.push('Event: ' + title.textContent);
        }
      });
      // Search students (if faculty)
      document.querySelectorAll('.student-item').forEach(function(st) {
        var name = st.querySelector('h4');
        if (name && name.textContent.toLowerCase().includes(query)) {
          results.push('Student: ' + name.textContent);
        }
      });
      // Search classes
      document.querySelectorAll('.class-item .class-name').forEach(function(cl) {
        if (cl.textContent.toLowerCase().includes(query)) {
          results.push('Class: ' + cl.textContent);
        }
      });
      // Add more search types as needed
      return results;
    }
    function doSearch() {
      var query = input.value;
      if (!query) return;
      var results = searchAll(query);
      showResults(results);
      modal.style.display = 'flex';
    }
    btn.addEventListener('click', doSearch);
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') doSearch();
    });
  });
</script>
<script src="{% static 'core/js/dashboard.js' %}"></script>
{% endblock %}