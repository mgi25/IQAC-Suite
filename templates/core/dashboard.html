{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard ‚Äì Event Management Suite{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="{% static 'core/css/dashboard.css' %}" id="dashboardCss">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    /* Fallback style if CSS fails to load */
    #dashboardCss[disabled] ~ .user-dashboard {
      background: #f8f9fa;
      color: #222;
    }
  </style>
  <script>
    // Fallback: If CSS fails to load, disable the link and show fallback
    window.addEventListener('DOMContentLoaded', function() {
      var css = document.getElementById('dashboardCss');
      if (css && css.sheet && css.sheet.cssRules.length === 0) {
        css.disabled = true;
      }
    });
  </script>
{% endblock %}

{% block content %}
<div class="user-dashboard">
    <div class="welcome-banner">
        <div class="banner-content">
            <h1>Welcome back, {{ user.first_name|default:user.username }}!</h1>
            <p>Here's your summary for today, {% now "F j, Y" %}.</p>
        </div>
    </div>

    <nav class="nav-tabs">
        <div class="nav-content">
            <button class="nav-tab active" data-tab="overview"><i class="fas fa-chart-line"></i> <span>Overview</span></button>
            <button class="nav-tab" data-tab="events"><i class="fas fa-calendar-alt"></i> <span>My Events</span></button>
            {% if not request.session.role or request.session.role != 'student' %}
            <button class="nav-tab" data-tab="students"><i class="fas fa-user-graduate"></i> <span>My Students</span></button>
            {% endif %}
            <button class="nav-tab" data-tab="profile"><i class="fas fa-user-circle"></i> <span>My Profile</span></button>

            {% if user.is_superuser %}
            <a href="/admin/" class="nav-tab"><i class="fas fa-cogs"></i> <span>Admin</span></a>
            {% endif %}
        </div>
    </nav>

    <main class="main-content">
        <div id="overview" class="tab-content active">
            {% if not request.session.role or request.session.role != 'student' %}
            <div class="overview-top-row">
                <div class="mentees-section-half">
                    <h3>My Top Mentees</h3>
                    <div class="mentees-list">
                        <div class="mentee-item">
                            <div class="mentee-avatar">SD</div>
                            <div class="mentee-info">
                                <h4>S. Devkrishna</h4>
                                <p>GPA: 8.5 | Attendance: 92%</p>
                                <span>Last meeting: 2 days ago</span>
                            </div>
                        </div>
                        <div class="mentee-item">
                            <div class="mentee-avatar">AG</div>
                            <div class="mentee-info">
                                <h4>Arisha Gupta</h4>
                                <p>GPA: 9.2 | Attendance: 96%</p>
                                <span>Last meeting: 1 week ago</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="calendar-section-half">
                    <h3>üìÖ Event Calendar</h3>
                    <div class="modern-calendar">
                        <div class="calendar-header">
                            <button id="prevMonth" class="calendar-nav-btn">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <h4 id="currentMonth"></h4>
                            <button id="nextMonth" class="calendar-nav-btn">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="calendar-container">
                            <div class="calendar-days-header">
                                <div class="calendar-day-header">Mo</div>
                                <div class="calendar-day-header">Tu</div>
                                <div class="calendar-day-header">We</div>
                                <div class="calendar-day-header">Th</div>
                                <div class="calendar-day-header">Fr</div>
                                <div class="calendar-day-header">Sa</div>
                                <div class="calendar-day-header">Su</div>
                            </div>
                            <div class="calendar-days" id="calendarDays">
                                <!-- Calendar days will be generated by JavaScript -->
                            </div>
                        </div>
                        <div class="calendar-footer">
                            <button class="calendar-done-btn" id="calendarDone">Done</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Event Details Modal -->
        <div id="eventModal" class="event-modal" style="display: none;">
            <div class="event-modal-content">
                <div class="event-modal-header">
                    <h3 id="eventModalTitle">Events on Selected Date</h3>
                    <button class="event-modal-close" onclick="closeEventModal()">&times;</button>
                </div>
                <div class="event-modal-body">
                    <div id="eventModalList" class="event-modal-list">
                        <!-- Event details will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Pass calendar events data to JavaScript
            window.DASHBOARD_EVENTS = {{ calendar_events|safe }};
        </script>

        <div id="events" class="tab-content">
            <div class="stats-row" style="display: flex; gap: 24px; margin-bottom: 24px;">
                <div class="stat-card blue clickable" id="cardUpcoming" style="flex: 1;">
                    <div class="stat-center">
                        <i class="fas fa-calendar stat-icon-large"></i>
                        <div class="stat-label">Upcoming Events</div>
                        <div class="stat-number">{{ upcoming_events_count }}</div>
                    </div>
                </div>
                <div class="stat-card green clickable" id="cardOrganized" style="flex: 1;">
                    <div class="stat-center">
                        <i class="fas fa-target stat-icon-large"></i>
                        <div class="stat-label">Organized Events</div>
                        <div class="stat-number">{{ organized_events_count }}</div>
                    </div>
                </div>
                <div class="stat-card purple" style="flex: 1;">
                    <div class="stat-center">
                        <i class="fas fa-users stat-icon-large"></i>
                        <div class="stat-label">Students Participated</div>
                        <div class="stat-number">{{ students_participated }}</div>
                    </div>
                </div>
                <div class="stat-card orange clickable" id="cardThisWeek" style="flex: 1;">
                    <div class="stat-center">
                        <i class="fas fa-calendar-week stat-icon-large"></i>
                        <div class="stat-label">This Week</div>
                        <div class="stat-number">{{ this_week_events }}</div>
                    </div>
                </div>
            </div>
            
            <div class="dashboard-events-bottom" style="display: flex; gap: 32px; align-items: stretch; margin-top: 24px; min-height: 500px;">
                <div class="dashboard-events-left" style="flex: 1; min-width: 0;">
                    <!-- Event Contribution Card -->
                    <div class="chart-card" style="margin-bottom: 24px;">
                        <h3>Event Contribution</h3>
                        {% if user.role_assignments.count > 1 %}
                            <div class="pie-chart-info">
                                <p>Your contributions by organization:</p>
                                <ul>
                                    {% for ra in user.role_assignments.all %}
                                        <li><strong>{{ ra.organization.name }}</strong>: {{ ra.contribution_percent|default:'0%' }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% else %}
                            <div class="pie-chart-info">
                                <p>Your contribution in <strong>{{ user.role_assignments.first.organization.name }}</strong>:</p>
                                <p class="pie-total">{{ user.role_assignments.first.contribution_percent|default:'0%' }}</p>
                            </div>
                        {% endif %}
                    </div>

                    <div class="filters-section">
                        <div class="filters-content">
                            <div class="filter-label"><i class="fas fa-filter"></i><span>Filters:</span></div>
                            <select class="filter-select" id="eventTypeFilter"><option value="">All Events</option><option value="my">My Events</option><option value="department">Department Events</option></select>
                            <select class="filter-select" id="eventTimeFilter"><option value="">This Month</option><option value="week">This Week</option><option value="next_month">Next Month</option></select>
                            <select class="filter-select" id="eventRoleFilter"><option value="">All Roles</option><option value="organizer">Organizer</option><option value="coordinator">Coordinator</option><option value="faculty_advisor">Faculty Advisor</option></select>
                        </div>
                    </div>
                    <div class="events-section" style="margin-top: 24px;">
                        <div class="section-header">
                            <h3>My Events</h3>
                            <a class="btn-primary" href="/suite/submit/">
                              <i class="fas fa-plus"></i> Create Event
                            </a>
                        </div>
                        <div class="events-list" id="myEventsList">
  {% for event in my_events %}
    <div class="event-item-card">
      <div class="event-main-info">
        <h4>{{ event.event_title }}</h4>
        <div class="event-details-row">
          <span class="event-date">üìç {{ event.event_datetime|date:"M d, Y H:i" }}</span>
          <span class="event-user">üë§ {{ event.submitted_by.get_full_name }}</span>
          <span class="event-participants">üë• {{ event.fest_fee_participants|default:event.conf_fee_participants }}</span>
        </div>
      </div>
      <div class="event-actions-row">
        <span class="status-badge {{ event.status|lower }}">{{ event.get_status_display }}</span>
        <button class="btn-icon" type="button" data-action="edit-event" data-event-id="{{ event.id }}"><i class="fas fa-edit"></i></button>
      </div>
    </div>
  {% empty %}
    <div class="empty-state">No events found.</div>
  {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="dashboard-events-right" style="flex: 1; min-width: 0;">
                   <div class="suite-right-section suite-glass">
        <div class="notif-heading">Notifications</div>
        <div class="notif-box">
          {% if user_proposals %}
          <ul class="notif-list">
            {% for proposal in user_proposals %}
            <li class="notif-item animate-fade-in">
              <div class="notif-row">
                <span class="notif-event-title">{{ proposal.event_title }}</span>
                {% if proposal.status == 'submitted' %}
                <span class="notif-status notif-status-pending">Submitted</span>
                {% elif proposal.status == 'under_review' %}
                <span class="notif-status notif-status-review">Under Review</span>
                {% elif proposal.status == 'rejected' %}
                <span class="notif-status notif-status-rejected">Rejected</span>
                {% elif proposal.status == 'finalized' %}
                <span class="notif-status notif-status-success">Finalized</span>
                {% endif %}
              </div>

              <div class="notif-meta-badge">
                <span class="notif-date-pill">
                  <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10m-13 6h14M4 21h16a2 2 0 002-2V7a2 2 0 00-2-2H4a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                  </svg>
                  Updated: {{ proposal.updated_at|date:"M d, Y H:i" }}
                </span>
                <span class="notif-age-pill">{{ proposal.updated_at|timesince }} ago</span>
              </div>


              <!-- MODERN PROGRESS CHART -->
              <div class="workflow-progress">
                <div class="progress-steps">
                  {% for status in proposal.statuses %}
                  <div class="progress-step">
                    <div class="progress-dot
                      {% if forloop.counter0 < proposal.status_index %}progress-dot-past{% endif %}
                      {% if forloop.counter0 == proposal.status_index %}progress-dot-current{% endif %}
                      {% if forloop.counter0 > proposal.status_index %}progress-dot-future{% endif %}
                    ">
                      {% if forloop.counter0 < proposal.status_index %}
                      <svg width="12" height="12" viewBox="0 0 12 12">
                        <circle cx="6" cy="6" r="5" fill="#22c55e"/>
                        <polyline points="4,6 6,8 9,4" fill="none" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                      {% elif forloop.counter0 == proposal.status_index %}
                      <svg width="12" height="12" viewBox="0 0 12 12">
                        <circle cx="6" cy="6" r="5" fill="#3b82f6"/>
                      </svg>
                      {% else %}
                      <svg width="12" height="12" viewBox="0 0 12 12">
                        <circle cx="6" cy="6" r="5" fill="#cbd5e1"/>
                      </svg>
                      {% endif %}
                    </div>
                    {% if not forloop.last %}
                    <div class="progress-step-line"></div>
                    {% endif %}
                    <div class="progress-step-label">{{ status|capfirst }}</div>
                  </div>
                  {% endfor %}
                </div>

                <div class="progress-bar-container">
                  <div class="progress-bar-fill" style="width: {{ proposal.progress_percent|default:'0' }}%;"></div>
                </div>
                <span class="progress-bar-label">
                  {{ proposal.progress_percent }}% complete ({{ proposal.current_label }})
                </span>
              </div>
              <!-- END CHART -->
              <a href="{% url 'emt:proposal_status_detail' proposal.id %}" class="notif-view-btn">View More Details ‚Üí</a>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <div class="notif-empty">
            <span>üéâ All clear! No proposals need your attention right now.</span>
          </div>
          {% endif %}
        </div>
      </div>
                </div>
            </div>
        </div>

        {% if not request.session.role or request.session.role != 'student' %}
        <div id="students" class="tab-content">
            <div class="search-section">
                <div class="search-content">
                    <div class="search-input">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" placeholder="Search students..." id="studentSearch">
                    </div>
                    <select class="filter-select" id="studentStatusFilter"><option value="">All Students</option><option value="need_checkin">Need Check-in</option><option value="doing_well">Doing Well</option></select>
                    <select class="filter-select" id="studentDeptFilter"><option value="">All Departments</option><option value="cs">Computer Science</option><option value="ece">Electronics</option><option value="me">Mechanical</option></select>
                </div>
            </div>

            <div class="students-section">
                <div class="section-header">
                    <h3>My Students</h3>
                    <button class="btn-primary" type="button" data-action="add-student">
                        <i class="fas fa-plus"></i> Add Student
                    </button>
                </div>
                <div class="students-list">
                    <div class="student-item" data-action="show-student-profile" data-student-id="1">
                        <div class="student-left">
                            <div class="student-avatar">SD</div>
                            <div class="student-info">
                                <h4>S. Devkrishna</h4>
                                <p class="student-reg">23112015 | 25 interactions</p>
                                <div class="student-stats">
                                    <span>üìä GPA: 8.5</span>
                                    <span>üìÖ Attendance: 92%</span>
                                    <span>üéØ Last meeting: 2 days ago</span>
                                </div>
                            </div>
                        </div>
                        <div class="student-actions">
                            <span class="status-badge warning">‚ö†Ô∏è Needs check-in</span>
                            <button class="btn-icon" type="button" data-action="message-student" data-student-id="1"><i class="fas fa-comment"></i></button>
                            <button class="btn-icon" type="button" data-action="call-student" data-student-id="1"><i class="fas fa-phone"></i></button>
                        </div>
                    </div>
                    <div class="student-item" data-action="show-student-profile" data-student-id="2">
                        <div class="student-left">
                            <div class="student-avatar">AG</div>
                            <div class="student-info">
                                <h4>Arisha Gupta</h4>
                                <p class="student-reg">23112002 | 14 interactions</p>
                                <div class="student-stats">
                                    <span>üìä GPA: 9.2</span>
                                    <span>üìÖ Attendance: 96%</span>
                                    <span>üéØ Last meeting: 1 week ago</span>
                                </div>
                            </div>
                        </div>
                        <div class="student-actions">
                            <span class="status-badge success">‚úÖ Doing well</span>
                            <button class="btn-icon" type="button" data-action="message-student" data-student-id="2"><i class="fas fa-comment"></i></button>
                            <button class="btn-icon" type="button" data-action="call-student" data-student-id="2"><i class="fas fa-phone"></i></button>
                        </div>
                    </div>
                    <div class="student-item" data-action="show-student-profile" data-student-id="3">
                        <div class="student-left">
                            <div class="student-avatar">RK</div>
                            <div class="student-info">
                                <h4>Rohit Kumar</h4>
                                <p class="student-reg">23112025 | 18 interactions</p>
                                <div class="student-stats">
                                    <span>üìä GPA: 7.8</span>
                                    <span>üìÖ Attendance: 88%</span>
                                    <span>üéØ Last meeting: 5 days ago</span>
                                </div>
                            </div>
                        </div>
                        <div class="student-actions">
                            <span class="status-badge warning">‚ö†Ô∏è Needs attention</span>
                            <button class="btn-icon" type="button" data-action="message-student" data-student-id="3"><i class="fas fa-comment"></i></button>
                            <button class="btn-icon" type="button" data-action="call-student" data-student-id="3"><i class="fas fa-phone"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div id="profile" class="tab-content">
            <div class="profile-section">
                <div class="profile-header">
                    <div class="profile-left">
                        <div class="profile-avatar-large">
                            {% if user.first_name %}
                                {{ user.first_name.0|upper }}{% if user.last_name %}{{ user.last_name.0|upper }}{% endif %}
                            {% else %}
                                {{ user.username.0|upper }}
                            {% endif %}
                        </div>
                        <div class="profile-info">
                            <h2>{{ user.get_full_name|default:user.username }}</h2>
                            <p>{{ user.email }}</p>
                            {% if user.role_assignments.exists %}
                              <p>
                                {% for ra in user.role_assignments.all %}
                                  {{ ra.organization.name }} &bull; {{ ra.role.name }}<br>
                                {% endfor %}
                              </p>
                            {% else %}
                              <p>No organization/role assigned.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="classes-section">
                <h3>üìö My Classes</h3>
                <div class="classes-list">
                    <div class="class-item">
                        <div>
                            <p class="class-name">CS101 - Programming Fundamentals</p>
                            <p class="class-students">45 students</p>
                        </div>
                        <button class="btn-link" type="button" data-action="view-class-details" data-class-id="1">View Details</button>
                    </div>
                    <div class="class-item">
                        <div>
                            <p class="class-name">CS301 - Data Structures</p>
                            <p class="class-students">32 students</p>
                        </div>
                        <button class="btn-link" type="button" data-action="view-class-details" data-class-id="2">View Details</button>
                    </div>
                    <div class="class-item">
                        <div>
                            <p class="class-name">CS401 - Database Systems</p>
                            <p class="class-students">28 students</p>
                        </div>
                        <button class="btn-link" type="button" data-action="view-class-details" data-class-id="3">View Details</button>
                    </div>
                </div>
            </div>

            <div class="profile-grid">
                <div class="achievements-section card">
                    <div class="section-header">
                        <h3>üèÜ My Achievements</h3>
                        <button class="btn-icon" type="button" data-action="add-achievement"><i class="fas fa-plus"></i></button>
                    </div>
                    <div class="achievements-list">
                        <div class="achievement-item">Best Faculty Award 2024</div>
                        <div class="achievement-item">Research Publication - AI in Education</div>
                        <div class="achievement-item">15 years of teaching experience</div>
                        <div class="achievement-item">Department Innovation Award</div>
                    </div>
                </div>

                <div class="goals-section card">
                    <div class="section-header">
                        <h3>üéØ Current Goals</h3>
                        <button class="btn-icon" type="button" data-action="add-goal"><i class="fas fa-plus"></i></button>
                    </div>
                    <div class="goals-list">
                        <div class="goal-item">
                            <p class="goal-text">Complete 10 LORs this month</p>
                            <div class="goal-progress">
                                <div class="progress-bar"><div class="progress-fill" style="width: 80%"></div></div>
                                <span class="progress-text">80%</span>
                            </div>
                        </div>
                        <div class="goal-item">
                            <p class="goal-text">Organize Tech Symposium</p>
                            <div class="goal-progress">
                                <div class="progress-bar"><div class="progress-fill" style="width: 70%"></div></div>
                                <span class="progress-text">70%</span>
                            </div>
                        </div>
                        <div class="goal-item">
                            <p class="goal-text">Publish Research Paper</p>
                            <div class="goal-progress">
                                <div class="progress-bar"><div class="progress-fill" style="width: 45%"></div></div>
                                <span class="progress-text">45%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

<div class="timeline-section">
    <h3>üìÖ This Year's Contributions</h3>
    <div class="timeline">
        <div class="timeline-item completed"><div class="timeline-dot"></div><div class="timeline-content"><h4>January</h4><p>Organized New Student Orientation</p><span class="timeline-status">completed</span></div></div>
        <div class="timeline-item completed"><div class="timeline-dot"></div><div class="timeline-content"><h4>February</h4><p>Research Paper Submission</p><span class="timeline-status">completed</span></div></div>
        <div class="timeline-item ongoing"><div class="timeline-dot"></div><div class="timeline-content"><h4>March</h4><p>Coordinating Tech Symposium</p><span class="timeline-status">ongoing</span></div></div>
        <div class="timeline-item planned"><div class="timeline-dot"></div><div class="timeline-content"><h4>April</h4><p>Student Career Guidance Workshop</p><span class="timeline-status">planned</span></div></div>
    </div>
</div>
        </div>
    </main>
</div>

<!-- Removed unwanted line at the bottom (if any element like <hr> or border div existed, it would be removed here) -->
{% endblock %}

{% block scripts_extra %}
<script src="{% static 'core/js/dashboard.js' %}"></script>
{% endblock %}