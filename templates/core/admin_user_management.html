{% extends "base.html" %}
{% load static %}

{% block head_extra %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
    rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">

<link rel="stylesheet" href="{% static 'core/css/admin_user_management.css' %}">

<style>
    .user-mgmt-container .filters-section {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .user-mgmt-container .filters-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .user-mgmt-container .filters-header h5 {
        margin: 0;
        color: #495057;
        font-weight: 600;
    }

    .user-mgmt-container .filter-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
    }

    .user-mgmt-container .filter-group label {
        font-size: 0.9rem;
        font-weight: 500;
        color: #6c757d;
        margin-bottom: 5px;
    }

    .user-mgmt-container .toggle-filters {
        background: none;
        border: none;
        color: #007bff;
        font-size: 0.9rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .user-mgmt-container.filters-collapsed .filter-content,
    .user-mgmt-container .filters-collapsed .filter-content {
        display: none;
    }

    .user-mgmt-container .btn-primary,
    .user-mgmt-container .dt-buttons .btn.btn-primary {
        background-color: var(--christ-blue) !important;
        border-color: var(--christ-blue) !important;
    }

    .user-mgmt-container .btn-primary:hover,
    .user-mgmt-container .dt-buttons .btn.btn-primary:hover {
        background-color: var(--christ-blue-dark) !important;
        border-color: var(--christ-blue-dark) !important;
    }

    .user-mgmt-container .admin-users-table thead th {
        background: var(--christ-blue);
        color: var(--white);
    }

    .user-mgmt-container .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice {
        background-color: var(--christ-blue);
        border-color: var(--christ-blue);
        color: #fff;
    }

    .user-mgmt-container .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice__remove {
        color: #fff;
    }

    /* DataTable overlay wrapper anchors the overlay to this section only */
    .user-mgmt-container .dt-overlay-wrapper {
        position: relative;
        min-height: 240px; /* prevent overlay jump on small tables */
    }

    /* Full-cover overlay that centers its content and fades in/out */
    .user-mgmt-container .dt-overlay {
        position: absolute;
        inset: 0; /* top/right/bottom/left: 0 */
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.72);
        backdrop-filter: blur(2px);
        z-index: 20000; /* ensure above DataTables buttons/headers */
        opacity: 0;
        visibility: hidden;
        pointer-events: none; /* don't block when hidden */
        transition: opacity .18s ease, visibility 0s linear .18s;
    }

    .user-mgmt-container .dt-overlay.show {
        opacity: 1;
        visibility: visible;
        pointer-events: auto; /* block interactions while loading */
        transition: opacity .18s ease; /* remove visibility delay when showing */
    }

    .user-mgmt-container .dt-overlay-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }

    .user-mgmt-container .dt-overlay-text {
        font-weight: 600;
        color: #1f2937;
    }

    /* Hide DataTables' built-in processing node to avoid double spinners */
    .user-mgmt-container .dataTables_processing {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="user-mgmt-container">
    <h1 class="mgmt-title">User Management</h1>

    <div class="filters-section" id="filtersSection">
        <div class="filters-header">
            <h5><i class="fas fa-filter"></i> Advanced Filters</h5>
            <button type="button" class="toggle-filters" id="toggleFiltersBtn">
                <span id="filterToggleText">Collapse</span>
                <i class="fas fa-chevron-up" id="filterToggleIcon"></i>
            </button>
        </div>

        <div class="filter-content">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="q">Search Users</label>
                    <input type="text" class="form-control" id="q" placeholder="Name, email, username...">
                </div>
                <div class="filter-group">
                    <label for="status">Account Status</label>
                    <select class="form-select" id="status">
                        <option value="" selected>All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="org_type">Organization Type</label>
                    <select class="form-select" id="org_type" name="org_type[]" multiple></select>
                </div>
                <div class="filter-group">
                    <label for="organization">Organization</label>
                    <select class="form-select" id="organization" name="organization[]" multiple></select>
                </div>
            </div>

            <div class="filter-row">
                <div class="filter-group">
                    <label for="role">Organization Role</label>
                    <select class="form-select" id="role" name="role[]" multiple
                        data-initial-roles='{{ initial_roles_json|safe }}'></select>
                </div>
                <div class="filter-group">
                    <div class="d-flex gap-2" style="margin-top: 32px;">
                        <button type="button" class="btn btn-primary w-100" id="applyFiltersBtn">
                            <i class="fas fa-search"></i> Apply Filters
                        </button>
                        <button type="button" class="btn btn-outline-secondary w-100" id="clearFiltersBtn">
                            <i class="fas fa-times"></i> Clear All
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--
      Wrap the DataTable with a positioned container so the overlay
      covers only this section (buttons + table), not the entire page.
    -->
    <div id="users-table-wrapper" class="table-responsive dt-overlay-wrapper">
        <table id="usersTable" class="admin-users-table table table-striped table-hover align-middle display nowrap"
            style="width:100%" data-api-url="{% url 'api_admin_search_users' %}">
            <thead>
                <tr>
                    <th>S.NO</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Roles</th>
                    <th>Organization</th>
                    <th>Date Joined</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>

        <!-- Centered loading overlay; initially hidden -->
        <div id="users-table-overlay" class="dt-overlay" aria-hidden="true">
            <div class="dt-overlay-content">
                <!-- Bootstrap 5 spinner -->
                <div class="spinner-border text-primary" role="status" aria-label="Loading"></div>
                <div class="dt-overlay-text">Loading users…</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.colVis.min.js"></script>

<script>
    $(document).ready(function () {
        class UserFilterManager {
            constructor() {
                this.table = null;
                this.apiUrl = $('#usersTable').data('api-url');
                // Cache overlay element for quick show/hide
                this.$overlay = $('#users-table-overlay');
            }

            init() {
                this.initSelect2();
                this.initDataTable();
                this.initEventListeners();
            }

            initSelect2() {
                const commonOptions = {
                    theme: 'bootstrap-5',
                    allowClear: true,
                    width: '100%',
                };

                $('#org_type').select2({
                    ...commonOptions,
                    placeholder: 'All Types',
                    ajax: {
                        url: '/core-admin/api/search/org-types/',
                        dataType: 'json',
                        delay: 250,
                        data: params => ({ search: params.term }),
                        processResults: data => ({
                            results: data.org_types.map(item => ({ id: item.id, text: item.name }))
                        }),
                        cache: true
                    }
                });

                $('#organization').select2({
                    ...commonOptions,
                    placeholder: 'All Organizations',
                    ajax: {
                        url: '/core-admin/api/filter/organizations/',
                        dataType: 'json',
                        delay: 250,
                        data: params => ({
                            'org_type_ids[]': $('#org_type').val(),
                            search: params.term
                        }),
                        processResults: data => ({
                            results: data.organizations.map(item => ({ id: item.id, text: `${item.name} (${item.org_type})` }))
                        }),
                    }
                });

                $('#role').select2({
                    ...commonOptions,
                    placeholder: 'All Roles',
                    ajax: {
                        url: '/core-admin/api/filter/roles/',
                        dataType: 'json',
                        delay: 250,
                        data: params => ({
                            'organization_ids[]': $('#organization').val(),
                            search: params.term
                        }),
                        processResults: data => ({
                            results: data.roles.map(item => ({ id: item.id, text: `${item.name} (${item.organization})` }))
                        }),
                    }
                });
            }

            initDataTable() {
                // Show overlay for the initial load before DataTables fires its first Ajax
                this.showOverlay();
                // Helpers to clean cell content for exports
                const stripHtml = (data) => {
                    if (data == null) return '';
                    let text = data.toString();
                    // Remove HTML tags and normalize whitespace
                    text = text.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
                    return text;
                };

                const cleanNameOnly = (data) => {
                    let text = stripHtml(data);
                    // If content includes a username or email-like token after the name, drop it.
                    // Keep only the portion before the first line break or ' @handle' or ' (extra)'.
                    text = text.split(/\r?\n|\s*\|\s*|<br\s*\/?>/i)[0];
                    // Remove trailing @handle or email-like fragments
                    text = text.replace(/\s*@[^\s]+/g, ' ').replace(/\s*\([^)]*\)\s*$/, ' ').trim();
                    return text;
                };

                this.table = $('#usersTable').DataTable({
                    searching: false, // disable global search box
                    processing: true,
                    serverSide: true,
                    ajax: {
                        url: this.apiUrl,
                        data: (d) => {
                            const filters = this.collectFilters();
                            d.q = filters.q;
                            d.status = filters.status;
                            d['org_type[]'] = filters.orgTypes;
                            d['organization[]'] = filters.organizations;
                            d['role[]'] = filters.roles;
                            d['role_name'] = filters.roleName; // For dashboard links
                        }
                    },
                    columns: [
                        { data: 's_no', name: 's_no', orderable: false, searchable: false },
                        { data: 'name', name: 'name' },
                        { data: 'email', name: 'email' },
                        { data: 'roles', name: 'roles', orderable: false, searchable: false },
                        { data: 'organization', name: 'organization', orderable: false, searchable: false },
                        { data: 'date_joined', name: 'date_joined' },
                        { data: 'status', name: 'status', orderable: false, searchable: false },
                        { data: 'action', name: 'action', orderable: false, searchable: false }
                    ],
                    // remove the filter box and keep buttons on the right like before
                    dom: '<"dt-toolbar d-flex justify-content-between align-items-center flex-wrap mb-3"<"dt-left"l><"dt-right"B>>rtip',
                    responsive: true,
                    pagingType: 'simple_numbers',
                    lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]],
                    pageLength: 25,
                    order: [[5, 'desc']],
                    columnDefs: [
                        { targets: [0, 5], className: 'text-center' },
                        { targets: [6], className: 'text-start' }
                    ],
                    buttons: [
                        {
                            text: 'Copy',
                            action: function (e, dt, button, config) {
                                const settings = dt.settings()[0];
                                const oldStart = settings._iDisplayStart;

                                dt.one('preXhr', function (e, s, data) {
                                    data.start = 0;
                                    data.length = 2147483647; // fetch all filtered rows
                                });

                                dt.one('xhr', function () {
                                    try {
                                        const headers = ['S.NO', 'Name', 'Email', 'Roles', 'Organization', 'Date Joined', 'Status'];
                                        const dataArr = dt.rows({ search: 'applied' }).data().toArray();

                                        const processed = dataArr.map(r => [
                                            (r && r.s_no != null) ? (typeof r.s_no === 'string' ? stripHtml(r.s_no) : String(r.s_no)) : '',
                                            cleanNameOnly(r && r.name != null ? r.name : ''),
                                            stripHtml(r && r.email != null ? r.email : ''),
                                            stripHtml(r && r.roles != null ? r.roles : ''),
                                            stripHtml(r && r.organization != null ? r.organization : ''),
                                            stripHtml(r && r.date_joined != null ? r.date_joined : ''),
                                            stripHtml(r && r.status != null ? r.status : '')
                                        ]);

                                        const caps = [4, 30, 40, 30, 36, 22, 14];
                                        const widths = headers.map((h, i) => {
                                            let maxLen = h.length;
                                            for (const row of processed) {
                                                const cell = (row[i] || '').toString();
                                                if (cell.length > maxLen) maxLen = cell.length;
                                            }
                                            return Math.min(maxLen, caps[i]);
                                        });

                                        const padRight = (str, len) => (str || '').toString().padEnd(len, ' ');
                                        const padLeft = (str, len) => (str || '').toString().padStart(len, ' ');
                                        const padCenter = (str, len) => {
                                            str = (str || '').toString();
                                            if (str.length >= len) return str.slice(0, len);
                                            const left = Math.floor((len - str.length) / 2);
                                            const right = len - str.length - left;
                                            return ' '.repeat(left) + str + ' '.repeat(right);
                                        };
                                        const trunc = (str, len) => {
                                            str = (str || '').toString();
                                            if (str.length <= len) return str;
                                            return str.slice(0, Math.max(0, len - 1)) + '…';
                                        };

                                        const sep = '  ';
                                        const headerLine = headers.map((h, i) => {
                                            if (i === 0) return padLeft(h, widths[i]);
                                            if (i === 5) return padCenter(h, widths[i]);
                                            return padRight(h, widths[i]);
                                        }).join(sep);
                                        const divider = headers.map((_, i) => '-'.repeat(widths[i])).join(sep);

                                        const lines = ['CHRIST University - Central Command Center', headerLine, divider];
                                        for (const row of processed) {
                                            const aligned = row.map((cell, i) => {
                                                const c = trunc(cell, widths[i]);
                                                if (i === 0) return padLeft(c, widths[i]);
                                                if (i === 5) return padCenter(c, widths[i]);
                                                return padRight(c, widths[i]);
                                            }).join(sep);
                                            lines.push(aligned);
                                        }

                                        const text = lines.join('\n');
                                        const copyText = async (t) => {
                                            try {
                                                if (navigator.clipboard && navigator.clipboard.writeText) {
                                                    await navigator.clipboard.writeText(t);
                                                    return true;
                                                }
                                            } catch (err) { /* ignore */ }
                                            const ta = document.createElement('textarea');
                                            ta.value = t;
                                            ta.style.position = 'fixed';
                                            ta.style.opacity = '0';
                                            document.body.appendChild(ta);
                                            ta.focus(); ta.select();
                                            let ok = false;
                                            try { ok = document.execCommand('copy'); } catch (e) { /* ignore */ }
                                            document.body.removeChild(ta);
                                            return ok;
                                        };
                                        copyText(text);
                                    } finally {
                                        dt.one('preXhr', function (e, s, data) { data.start = oldStart; });
                                        setTimeout(function () {
                                            dt.ajax.reload(function () {
                                                dt.page(Math.floor(oldStart / dt.page.len())).draw('page');
                                            }, false);
                                        }, 0);
                                    }
                                });

                                dt.ajax.reload();
                            }
                        },
                        {
                            extend: 'excelHtml5',
                            text: 'Excel',
                            exportOptions: {
                                // Exclude the last 'Action' column from export
                                columns: [0, 1, 2, 3, 4, 5, 6],
                                format: {
                                    body: function (data, row, column, node) {
                                        if (column === 1) { // Name column
                                            return cleanNameOnly(data);
                                        }
                                        return stripHtml(data);
                                    }
                                }
                            },
                            action: function (e, dt, button, config) {
                                const self = this;
                                const settings = dt.settings()[0];
                                const oldStart = settings._iDisplayStart;

                                dt.one('preXhr', function (e, s, data) {
                                    data.start = 0;
                                    data.length = 2147483647; // fetch all filtered rows
                                });

                                dt.one('xhr', function () {
                                    $.fn.dataTable.ext.buttons.excelHtml5.action.call(self, e, dt, button, config);

                                    // Restore original paging
                                    dt.one('preXhr', function (e, s, data) {
                                        data.start = oldStart;
                                    });

                                    setTimeout(function () {
                                        dt.ajax.reload(function () {
                                            dt.page(Math.floor(oldStart / dt.page.len())).draw('page');
                                        }, false);
                                    }, 0);
                                });

                                dt.ajax.reload();
                            }
                        },
                        {
                            extend: 'pdfHtml5',
                            text: 'PDF',
                            orientation: 'landscape',
                            pageSize: 'A3',
                            title: 'CHRIST University - Central Command Center',
                            exportOptions: {
                                // Exclude the last 'Action' column from export
                                columns: [0, 1, 2, 3, 4, 5, 6],
                                format: {
                                    body: function (data, row, column, node) {
                                        if (column === 1) { // Name column
                                            return cleanNameOnly(data);
                                        }
                                        return stripHtml(data);
                                    }
                                }
                            },
                            customize: function (doc) {
                                // Margins and base styles
                                doc.pageMargins = [20, 20, 28, 20]; // a bit more right margin
                                doc.defaultStyle.fontSize = 9;
                                doc.styles.tableHeader = doc.styles.tableHeader || {};
                                doc.styles.tableHeader.fillColor = '#1e3a8a';
                                doc.styles.tableHeader.color = '#ffffff';
                                doc.styles.tableHeader.alignment = 'left';
                                doc.styles.tableHeader.fontSize = 10;
                                doc.styles.tableHeader.bold = true;

                                // Title styling (sans-serif look)
                                doc.styles.reportTitle = {
                                    fontSize: 18,
                                    bold: true,
                                    alignment: 'center',
                                    color: '#111827',
                                    margin: [0, 0, 0, 12]
                                };
                                if (doc.content && doc.content.length && doc.content[0] && doc.content[0].text) {
                                    doc.content[0].style = 'reportTitle';
                                }

                                // Find the table node and set column widths and layout
                                var tableNode = null;
                                for (var i = 0; i < doc.content.length; i++) {
                                    if (doc.content[i].table) { tableNode = doc.content[i]; break; }
                                }
                                if (tableNode && tableNode.table && tableNode.table.body && tableNode.table.body.length) {
                                    // widths for: S.NO, Name, Email, Roles, Organization, Date Joined, Status (A3 landscape)
                                    // Reduce Roles, increase Status per request
                                    tableNode.table.widths = [40, 200, 280, 130, 220, 120, 160];
                                    tableNode.layout = {
                                        hLineWidth: function (i, node) { return i === 0 || i === node.table.body.length ? 1 : 0.5; },
                                        vLineWidth: function () { return 0.5; },
                                        hLineColor: function () { return '#e5e7eb'; },
                                        vLineColor: function () { return '#e5e7eb'; },
                                        paddingLeft: function () { return 6; },
                                        paddingRight: function () { return 6; },
                                        paddingTop: function () { return 4; },
                                        paddingBottom: function () { return 4; }
                                    };

                                    // Center-align S.NO, Date Joined, Status columns for neatness
                                    var body = tableNode.table.body;
                                    var header = body[0];
                                    function ensureObj(cell) {
                                        if (cell == null) return { text: '' };
                                        if (typeof cell === 'string') return { text: cell };
                                        if (Array.isArray(cell)) return { text: cell.join(' ') };
                                        return cell; // already an object
                                    }

                                    // Header alignments
                                    header[0] = ensureObj(header[0]); header[0].alignment = 'center';
                                    header[5] = ensureObj(header[5]); header[5].alignment = 'center';
                                    header[6] = ensureObj(header[6]); header[6].alignment = 'center';

                                    // Row alignments
                                    for (var r = 1; r < body.length; r++) {
                                        body[r][0] = ensureObj(body[r][0]);
                                        body[r][0].alignment = 'center';

                                        body[r][5] = ensureObj(body[r][5]);
                                        body[r][5].alignment = 'center';

                                        body[r][6] = ensureObj(body[r][6]);
                                        body[r][6].alignment = 'left';
                                        // allow wrapping to avoid cropping on smaller screens/printers
                                    }
                                    // Add a bit of extra right margin to the table
                                    tableNode.margin = [0, 0, 10, 0];
                                }
                            },
                            action: function (e, dt, button, config) {
                                const self = this;
                                const settings = dt.settings()[0];
                                const oldStart = settings._iDisplayStart;

                                dt.one('preXhr', function (e, s, data) {
                                    data.start = 0;
                                    data.length = 2147483647; // fetch all filtered rows
                                });

                                dt.one('xhr', function () {
                                    $.fn.dataTable.ext.buttons.pdfHtml5.action.call(self, e, dt, button, config);

                                    // Restore original paging
                                    dt.one('preXhr', function (e, s, data) {
                                        data.start = oldStart;
                                    });

                                    setTimeout(function () {
                                        dt.ajax.reload(function () {
                                            dt.page(Math.floor(oldStart / dt.page.len())).draw('page');
                                        }, false);
                                    }, 0);
                                });

                                dt.ajax.reload();
                            }
                        },
                        {
                            extend: 'print',
                            text: 'Print',
                            title: 'CHRIST University - Central Command Center',
                            exportOptions: {
                                columns: [0, 1, 2, 3, 4, 5, 6],
                                format: {
                                    body: function (data, row, column, node) {
                                        if (column === 1) { return cleanNameOnly(data); }
                                        return stripHtml(data);
                                    }
                                }
                            },
                            customize: function (win) {
                                var css = `
                                    @page { size: A3 landscape; margin: 10mm; }
                                    body { font-family: Arial, Helvetica, sans-serif; font-size: 10pt; color: #111827; }
                                    h1 { font-family: Arial, Helvetica, sans-serif; font-weight: 700; letter-spacing: .2px; text-align: center; margin-bottom: 10mm; }
                                    table.dataTable { width: 100% !important; border-collapse: collapse !important; }
                                    table.dataTable th, table.dataTable td { padding: 6px 8px; border: 1px solid #e5e7eb; }
                                    table.dataTable thead th { background: #1e3a8a !important; color: #fff !important; }
                                    table.dataTable tbody tr:nth-child(odd) { background: #f7f7f7; }
                                    /* Column widths and alignment */
                                    table.dataTable th:nth-child(1), table.dataTable td:nth-child(1) { width: 5%; text-align: center; }
                                    table.dataTable th:nth-child(2), table.dataTable td:nth-child(2) { width: 18%; }
                                    table.dataTable th:nth-child(3), table.dataTable td:nth-child(3) { width: 26%; }
                                    table.dataTable th:nth-child(4), table.dataTable td:nth-child(4) { width: 12%; }
                                    table.dataTable th:nth-child(5), table.dataTable td:nth-child(5) { width: 20%; }
                                    table.dataTable th:nth-child(6), table.dataTable td:nth-child(6) { width: 9%; text-align: center; }
                                    table.dataTable th:nth-child(7), table.dataTable td:nth-child(7) { width: 10%; text-align: left; }
                                `;
                                var head = win.document.head || win.document.getElementsByTagName('head')[0];
                                var style = win.document.createElement('style');
                                style.type = 'text/css';
                                style.media = 'print';
                                style.appendChild(win.document.createTextNode(css));
                                head.appendChild(style);
                            },
                            action: function (e, dt, button, config) {
                                const self = this;
                                const settings = dt.settings()[0];
                                const oldStart = settings._iDisplayStart;

                                dt.one('preXhr', function (e, s, data) {
                                    data.start = 0;
                                    data.length = 2147483647; // all filtered rows
                                });

                                dt.one('xhr', function () {
                                    $.fn.dataTable.ext.buttons.print.action.call(self, e, dt, button, config);

                                    // Restore original paging
                                    dt.one('preXhr', function (e, s, data) {
                                        data.start = oldStart;
                                    });

                                    setTimeout(function () {
                                        dt.ajax.reload(function () {
                                            dt.page(Math.floor(oldStart / dt.page.len())).draw('page');
                                        }, false);
                                    }, 0);
                                });

                                dt.ajax.reload();
                            }
                        },
                        'colvis'
                    ],
                    language: { search: "_INPUT_", searchPlaceholder: "Search table..." },
                    initComplete: () => {
                        // Apply filters from URL after the table is fully initialized
                        this.applyFiltersFromURL();
                    }
                });

                // Tie overlay visibility to DataTables lifecycle
                // Show whenever processing starts; hide when it ends
                $('#usersTable').on('processing.dt', (e, settings, processing) => {
                    processing ? this.showOverlay() : this.hideOverlay();
                });
                // Extra safety: before XHR show; after XHR/draw hide
                $('#usersTable').on('preXhr.dt', () => this.showOverlay());
                $('#usersTable').on('xhr.dt draw.dt', () => this.hideOverlay());

                $.fn.dataTable.ext.errMode = 'none';
                $('#usersTable').on('error.dt', (e, settings, techNote, message) => {
                    console.error('DataTables error:', message);
                });
            }

            initEventListeners() {
                $('#applyFiltersBtn').on('click', () => this.applyFilters(true));
                $('#clearFiltersBtn').on('click', () => this.clearFilters());
                $('#toggleFiltersBtn').on('click', () => this.toggleFilterVisibility());

                $('#org_type').on('change', () => {
                    $('#organization').val(null).trigger('change');
                });
                $('#organization').on('change', () => {
                    $('#role').val(null).trigger('change');
                });
                // Trigger Apply Filters on Enter key in any filter input
                const filterInputs = [
                    '#q',
                    '#status',
                    '#org_type',
                    '#organization',
                    '#role'
                ];
                filterInputs.forEach(selector => {
                    $(selector).on('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.applyFilters(true);
                        }
                    });
                });
            }
            

            collectFilters() {
                const params = new URLSearchParams(window.location.search);
                return {
                    q: $('#q').val(),
                    status: $('#status').val(),
                    orgTypes: $('#org_type').val() || [],
                    organizations: $('#organization').val() || [],
                    roles: $('#role').val() || [],
                    roleName: params.get('role')
                };
            }

            applyFilters(updateUrl = false) {
                // Show overlay immediately on user action, then reload
                this.showOverlay();
                this.table.ajax.reload();
                if (updateUrl) {
                    this.updateURL();
                }
            }

            clearFilters() {
                const currentUrl = new URL(window.location);
                currentUrl.search = ''; // Clear all query parameters
                history.pushState(null, '', currentUrl.toString());

                $('#q, #status').val('');
                $('#org_type, #organization, #role').val(null).trigger('change');
                // Show overlay and reload after clearing filters
                this.showOverlay();
                this.table.ajax.reload();
            }

            updateURL() {
                const filters = this.collectFilters();
                const params = new URLSearchParams();

                if (filters.q) params.set('q', filters.q);
                if (filters.status) params.set('status', filters.status);

                // Do not persist the 'role' name param once a specific ID is chosen
                if (filters.roleName && (!filters.roles || filters.roles.length === 0)) {
                    params.set('role', filters.roleName);
                }

                filters.orgTypes.forEach(id => params.append('org_type[]', id));
                filters.organizations.forEach(id => params.append('organization[]', id));
                filters.roles.forEach(id => params.append('role[]', id));

                const newUrl = `${window.location.pathname}?${params.toString()}`;
                history.pushState(null, '', newUrl);
            }

            applyFiltersFromURL() {
                const params = new URLSearchParams(window.location.search);
                $('#q').val(params.get('q') || '');
                $('#status').val(params.get('status') || '');

                // Handle initial role from dashboard redirect
                const initialRolesData = $('#role').data('initial-roles');
                if (initialRolesData && initialRolesData.length > 0) {
                    const selectRole = $('#role');
                    selectRole.empty(); // Clear existing options
                    initialRolesData.forEach(role => {
                        // Create a new option and select it
                        const option = new Option(role.text, role.id, true, true);
                        selectRole.append(option);
                    });
                    selectRole.trigger('change'); // Notify Select2
                } else {
                    // Handle manual filters if no initial role
                    this.prepopulateSelect2FromURL('role', params.getAll('role[]'), '/core-admin/api/filter/roles/', 'roles');
                }

                // Pre-populate other filters
                this.prepopulateSelect2FromURL('org_type', params.getAll('org_type[]'), '/core-admin/api/search/org-types/', 'org_types');
                this.prepopulateSelect2FromURL('organization', params.getAll('organization[]'), '/core-admin/api/filter/organizations/', 'organizations');
            }

            prepopulateSelect2FromURL(elementId, values, ajaxUrl, dataKey) {
                if (!values || values.length === 0) return;

                const select = $(`#${elementId}`);
                if (select.val() && select.val().length > 0) return;

                const fetchPromises = values.map(id => $.ajax({
                    url: ajaxUrl,
                    data: { 'id': id } // Assuming API can fetch by a single ID
                }));

                Promise.all(fetchPromises).then(responses => {
                    responses.forEach((response, index) => {
                        const items = response[dataKey] || [];
                        const item = items.find(d => d.id == values[index]);
                        if (item) {
                            const text = item.org_type ? `${item.name} (${item.org_type})` :
                                item.organization ? `${item.name} (${item.organization})` :
                                    item.name;
                            const option = new Option(text, item.id, true, true);
                            select.append(option);
                        }
                    });
                    select.trigger('change');
                });
            }

            toggleFilterVisibility() {
                $('#filtersSection').toggleClass('filters-collapsed');
                const isCollapsed = $('#filtersSection').hasClass('filters-collapsed');
                $('#filterToggleIcon').toggleClass('fa-chevron-up fa-chevron-down');
                $('#filterToggleText').text(isCollapsed ? 'Expand' : 'Collapse');
            }

            // Overlay helpers to control loader visibility
            showOverlay() { this.$overlay.addClass('show').attr('aria-hidden', 'false'); }
            hideOverlay() { setTimeout(() => this.$overlay.removeClass('show').attr('aria-hidden', 'true'), 80); }
        }

        const manager = new UserFilterManager();
        manager.init();
        // Expose helpers globally so export buttons can control the overlay lifecycle
        window.showUserMgmtOverlay = () => manager.showOverlay();
        window.hideUserMgmtOverlay = () => manager.hideOverlay();
    });
</script>
{% endblock %}