{% extends "base.html" %}
{% load static %}
{% load dict_filters %}

{% block title %}Master Data Management{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'core/css/admin_master_data.css' %}?v=3.0">
{% endblock %}

{% block content %}
<div class="ems-dashboard mdm-page">


  <!-- Heading (Dashboard style: black, compact) -->
  <header class="topbar">
    <div>
      <h1>Master Data Management</h1>
    </div>
  </header>

  <!-- Controls: Category → Status → Search → Add Entry → Add Category -->
  <div class="controls-container" id="controlsBar">
    <div class="filters-left">
      <label class="filter">
        <span class="fs-6">Category</span>
        <select id="categoryFilter" aria-label="Select category" class="form-control">
          {% for org_type in org_types %}
          {% with key=org_type.name|lower %}
          <option value="{{ key }}"
            data-can-have-parent="{% if org_type.can_have_parent %}true{% else %}false{% endif %}"
            data-parent-type="{% if org_type.parent_type %}{{ org_type.parent_type.name|lower }}{% endif %}">
            {{ org_type.name }}{% if not key == 'cell' %}{% endif %}
          </option>
          {% endwith %}
          {% endfor %}
        </select>
      </label>

      <label class="filter">
        <span class="fs-6">Status</span>
        <select id="statusFilter" aria-label="Filter by status" class="form-control">
          <option value="all">All</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
        </select>
      </label>

      <!-- <div class="search-bar">
        <i class="fas fa-search"></i>
        <input type="text" id="universalSearch" placeholder="Search in selected category…" aria-label="Search">
        <button class="search-clear" id="searchClearBtn" title="Clear search" aria-label="Clear search">×</button>
      </div> -->
      <div class="search-bar d-flex align-items-center gap-2"
        style="background-color: transparent !important;  border: none !important; border-radius: 0 !important; border-radius: 10 !important;">
        <i class="fas fa-search"></i>
        <input type="text" class="form-control flex-grow-1" id="universalSearch" placeholder="Search organizations..."
          aria-label="Search">
        <button class="btn btn-outline-secondary" id="searchClearBtn" title="Clear search"
          aria-label="Clear search">×</button>
      </div>
    </div>

    <div class="main-actions">
      <button class="btn btn-primary" id="addNewEntryBtn" title="Add new entry">
        <i class="fas fa-plus"></i><span class="btn-label">Add New Entry</span>
      </button>
      <button class="btn btn-secondary" id="addNewCategoryBtn" title="Add new category">
        <i class="fas fa-layer-group"></i><span class="btn-label">Add New Category</span>
      </button>
    </div>
  </div>

  <!-- Add Entry Panel -->
  <div id="add-form-container" class="add-form-container" style="display:none;">
    <div class="form-group">
      <label for="categorySelect">Category</label>
      <select id="categorySelect">
        {% for org_type in org_types %}
        {% with key=org_type.name|lower %}
        <option value="{{ key }}" data-can-have-parent="{% if org_type.can_have_parent %}true{% else %}false{% endif %}"
          data-parent-type="{% if org_type.parent_type %}{{ org_type.parent_type.name|lower }}{% endif %}">
          {{ org_type.name }}
        </option>
        {% endwith %}
        {% endfor %}
      </select>
    </div>
    <div class="form-group">
      <label for="newEntryName">Name</label>
      <input type="text" id="newEntryName" placeholder="Enter the name">
    </div>
    <div id="parent-organization-group" class="form-group" style="display:none;">
      <label for="parentOrganizationSelect">Parent Organization</label>
      <select id="parentOrganizationSelect">
        <option value="" disabled selected>Select Parent</option>
      </select>
      <div class="hint" id="parentHint" aria-live="polite"></div>
    </div>
    <div class="form-actions">
      <button class="btn btn-primary" id="addEntryConfirmBtn"><i class="fas fa-check"></i> Add</button>
      <button class="btn btn-secondary" id="addEntryCancelBtn">Cancel</button>
    </div>
  </div>

  <!-- Add Category Panel -->
  <div id="add-category-container" class="add-form-container" style="display:none;">
    <div class="form-group">
      <label for="newCategoryName">Category Name</label>
      <input type="text" id="newCategoryName" placeholder="Enter new category (e.g., Committee)">
    </div>
    <div class="form-group checkbox-row">
      <label><input type="checkbox" id="hasParentCategory"> Has A Parent Category?</label>
    </div>
    <div class="form-group" id="parentCategoryGroup" style="display:none;">
      <label for="parentCategorySelect">Parent Category</label>
      <select id="parentCategorySelect">
        <option value="">-- Select Parent Category --</option>
        {% for org_type in org_types %}
        <option value="{{ org_type.id }}">{{ org_type.name }}</option>
        {% endfor %}
      </select>
      <div class="hint">This controls available parent options when adding entries.</div>
    </div>
    <div class="form-actions">
      <button class="btn btn-primary" id="addCategoryConfirmBtn"><i class="fas fa-check"></i> Add Category</button>
      <button class="btn btn-secondary" id="addCategoryCancelBtn">Cancel</button>
    </div>
  </div>

  <!-- Edit Category Modal -->
  <div class="modal fade" id="editCategoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg rounded-4">
        <form id="editCategoryForm">
          {% csrf_token %}
          <div class="modal-header" style="background-color: #0d6efd; color: white;">
            <h5 class="modal-title fw-semibold">Edit Category</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body bg-light">
            <input type="hidden" id="editCategoryId">
            <div class="form-group mb-3">
              <label for="editCategoryName" class="form-label fw-medium">Category Name</label>
              <input type="text" id="editCategoryName" class="form-control" required>
            </div>

            <div class="form-group mb-3">
              <label for="editParentCategory" class="form-label fw-medium">Parent Category</label>
              <select id="editParentCategory" class="form-select">
                <option value="">-- None --</option>
                {% for org_type in org_types %}
                <option value="{{ org_type.id }}">{{ org_type.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="modal-footer d-flex justify-content-between bg-light border-top-0">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn text-white" style="background-color: #0d6efd;">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>


  <!-- Category List with Edit/Delete -->
  <div class="category-list mt-4">
    <h5>Existing Categories</h5>
    <table class="table table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th>Category Name</th>
          <th>Parent Category</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for org_type in org_types %}
        <tr>
          <td>{{ org_type.name }}</td>
          <td>{% if org_type.parent_type %}{{ org_type.parent_type.name }}{% else %}-{% endif %}</td>
          <td>
            <button type="button" class="btn btn-sm btn-outline-primary edit-category-btn" data-id="{{ org_type.id }}"
              data-name="{{ org_type.name }}"
              data-parent="{% if org_type.parent_type %}{{ org_type.parent_type.id }}{% endif %}" title="Edit Category">
              <i class="fas fa-edit"></i>
            </button>
            <form action="{% url 'delete_category' org_type.id %}" method="post" style="display:inline;">
              {% csrf_token %}
              <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete Category"
                onclick="return confirm('Are you sure you want to delete this category?');">
                <i class="fas fa-trash"></i>
              </button>
            </form>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="3" class="text-center">No categories available.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Tables: server renders one panel per category; JS shows the selected one -->
  <div class="tab-panels">
    {% for org_type in org_types %}
    {% with key=org_type.name|lower %}
    <section id="panel-{{ key }}" class="tab-panel{% if forloop.first %} is-active{% endif %}" role="region"
      aria-label="{{ org_type.name }}" data-type="{{ key }}">
      <div class="table-wrap">
        <table class="data-table">
          <thead>
            <tr>
              <th class="th-name">Name</th>
              {% if org_type.can_have_parent %}
              <th class="th-parent">Parent</th>
              {% endif %}
              <th class="th-status">Status</th>
              <th class="th-actions">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for entry in orgs_by_type|get_item:org_type.name %}
            <tr data-id="{{ entry.id }}" data-type="{{ key }}"
              class="{% if not entry.is_active %}inactive-row-display{% endif %}">
              <td data-label="Name">{{ entry.name }}</td>
              {% if org_type.can_have_parent %}
              <td data-label="Parent">
                {% if entry.parent %}{{ entry.parent.name }}{% else %}-{% endif %}
              </td>
              {% endif %}
              <td data-label="Status">
                <span class="status-badge status-{% if entry.is_active %}active{% else %}inactive{% endif %}">
                  {% if entry.is_active %}Active{% else %}Inactive{% endif %}
                </span>
              </td>
              <td data-label="Actions" class="actions">
                <!-- Icon-only, compact, tooltips -->
                <button class="icon-btn btn-edit" title="Edit Entry" aria-label="Edit Entry">
                  <i class="fas fa-pen"></i>
                </button>
                {% if request.user.is_superuser %}
                <a class="icon-btn" title="Add Users" aria-label="Add Users"
                  href="{% url 'admin_org_users_select_role' entry.id %}">
                  <i class="fas fa-user-plus"></i>
                </a>
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="{% if org_type.can_have_parent %}4{% else %}3{% endif %}" class="text-center">No {{ key }}
                found.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
    {% endwith %}
    {% endfor %}
  </div>

  <!-- Universal search (selected category scope): no-results -->
  <div id="search-not-found" class="search-not-found" style="display:none;">
    <p>No results found for "<strong></strong>".</p>
    <button class="btn btn-primary" id="addFromSearchBtn"><i class="fas fa-plus"></i> Add As New Entry</button>
  </div>
</div>

<div id="toast-notification" class="toast" aria-live="polite"></div>
{% endblock %}

{% block scripts %}
<script>
  window.orgsByType = JSON.parse('{{ orgs_by_type_json|safe }}');
</script>
<script src="{% static 'core/js/admin_master_data.js' %}?v=3.0"></script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const editButtons = document.querySelectorAll('.edit-category-btn');
    const modalEl = document.getElementById('editCategoryModal');
    const modal = new bootstrap.Modal(modalEl);
    const form = document.getElementById('editCategoryForm');

    editButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        // Prefill modal fields
        document.getElementById('editCategoryId').value = btn.dataset.id;
        document.getElementById('editCategoryName').value = btn.dataset.name;
        document.getElementById('editParentCategory').value = btn.dataset.parent || '';
        modal.show();
      });
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('editCategoryId').value;
      const name = document.getElementById('editCategoryName').value;
      const parent = document.getElementById('editParentCategory').value;

      const response = await fetch(`/category/${id}/edit/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ name: name, parent_type: parent })
      });

      if (response.ok) {
        modal.hide();
        location.reload();
      } else {
        alert('Error updating category.');
      }
    });
  });
</script>
{% endblock %}