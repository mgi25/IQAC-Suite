{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'core/css/admin_nav_permissions.css' %}">
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet"/>
{% endblock %}

{% block content %}
<div class="sidebar-permissions-bg">
  <div class="sidebar-permissions-container">
    <h1 class="mb-4">Sidebar Permissions</h1>
    <form method="post" id="sidebar-permission-form">
      {% csrf_token %}
      <div class="sp-selection-row">
        <div class="sp-field">
          <label for="user_select">User</label>
          <select name="user" id="user_select" class="form-select" placeholder="Search user...">
            <option value="">-- Select User --</option>
            {% for u in users %}
            <option value="{{ u.id }}" {% if selected_user|default:'' == u.id|stringformat:'s' %}selected{% endif %}>{{ u.username }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="sp-field">
          <label for="role_select">Role</label>
          <select name="role" id="role_select" class="form-select" placeholder="Search role...">
            <option value="">-- Select Role --</option>
            {% for r in roles %}
            <option value="{{ r }}" {% if selected_role == r %}selected{% endif %}>{{ r|capfirst }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="dual-list mt-4">
        <div class="dual-list-column">
          <label class="form-label" for="available">Available</label>
          <input type="text" id="available_filter" class="form-control mb-2" placeholder="Filter">
          <select id="available" class="form-select" multiple>
            {% for key,label in nav_items %}
            {% if not permission or key not in permission.items %}
            <option value="{{ key }}">{{ label }}</option>
            {% endif %}
            {% endfor %}
          </select>
        </div>

        <div class="dual-list-buttons">
          <button type="button" id="add_btn" class="btn btn-outline-primary mb-2" aria-label="Add selected">&gt;</button>
          <button type="button" id="remove_btn" class="btn btn-outline-primary" aria-label="Remove selected">&lt;</button>
        </div>

        <div class="dual-list-column">
          <label class="form-label" for="assigned">Assigned</label>
          <input type="text" id="assigned_filter" class="form-control mb-2" placeholder="Filter">
          <select id="assigned" name="items" class="form-select" multiple>
            {% if permission %}
            {% for key,label in nav_items %}
              {% if key in permission.items %}
              <option value="{{ key }}">{{ label }}</option>
              {% endif %}
            {% endfor %}
            {% endif %}
          </select>
        </div>
      </div>

      <div class="text-end mt-3">
        <button type="submit" class="btn btn-primary">Save</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  // Enable TomSelect typeahead for user and role selects
  new TomSelect('#user_select', {allowEmptyOption: true});
  new TomSelect('#role_select', {allowEmptyOption: true});

  function moveOptions(from, to) {
    Array.from(from.selectedOptions).forEach(function (opt) {
      opt.selected = false;
      to.add(opt);
    });
  }

  const addBtn = document.getElementById('add_btn');
  const removeBtn = document.getElementById('remove_btn');
  const available = document.getElementById('available');
  const assigned = document.getElementById('assigned');

  addBtn.addEventListener('click', function () {
    moveOptions(available, assigned);
  });

  removeBtn.addEventListener('click', function () {
    moveOptions(assigned, available);
  });

  document.getElementById('sidebar-permission-form').addEventListener('submit', function () {
    Array.from(assigned.options).forEach(function (opt) {
      opt.selected = true;
    });
  });

  function filterList(input, select) {
    const term = input.value.toLowerCase();
    Array.from(select.options).forEach(function (opt) {
      const show = opt.text.toLowerCase().includes(term);
      opt.style.display = show ? '' : 'none';
    });
  }

  const availableFilter = document.getElementById('available_filter');
  const assignedFilter = document.getElementById('assigned_filter');

  availableFilter.addEventListener('keyup', function () {
    filterList(availableFilter, available);
  });
  assignedFilter.addEventListener('keyup', function () {
    filterList(assignedFilter, assigned);
  });
});
</script>
{% endblock %}
