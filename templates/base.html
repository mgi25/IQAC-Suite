{% load static group_filters admin_tags %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}CHRIST University - Central Command Center{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="{% static 'core/img/favicon.ico' %}">
  
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  
  <!-- Styles -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="{% static 'core/css/base.css' %}">
  {% block extra_css %}{% endblock %}
  
  {% block head_extra %}{% endblock %}
  <!-- CSRF token for JS (fallback to cookie also implemented in scripts) -->
  <meta name="csrf-token" content="{{ csrf_token }}">
  <!-- Auth status for JS (avoids inline template in script) -->
  <meta name="authenticated" content="{{ request.user.is_authenticated|yesno:'true,false' }}">
  <script>
    window.USER_ID = "{{ request.user.id|default:'' }}";
  </script>
</head>
{% with has_sidebar=unrestricted_nav or allowed_nav_items|length %}
<body class="command-center-layout{% if not has_sidebar %} no-sidebar{% endif %}">

  {% if messages %}
  <div class="toast-container" aria-live="polite" aria-atomic="true">
    {% for message in messages %}
    <div class="toast-message {{ message.tags }}" role="alert">{{ message }}</div>
    {% endfor %}
  </div>
  {% endif %}

  {% impersonation_banner %}

  <!-- ZONE 1: TOP UTILITY BAR -->
  <div class="top-utility-bar">
    <div class="utility-bar-flex" style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
      <div class="utility-left" style="display: flex; align-items: center; gap: 1rem;">
        {% if has_sidebar %}
        <button id="sidebarToggle" aria-label="Toggle sidebar" style="background:transparent;border:none;color:#fff;font-size:20px;display:flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:8px;">
          <span style="display:inline-block;width:18px;height:2px;background:#fff;position:relative;">
            <span style="content:'';position:absolute;left:0;top:-6px;width:18px;height:2px;background:#fff"></span>
            <span style="content:'';position:absolute;left:0;top:6px;width:18px;height:2px;background:#fff"></span>
          </span>
        </button>
        {% endif %}
        <div class="app-logo" style="display: flex; align-items: center; gap: 0.75rem;">
          <img src="{% static 'core/img/campus-logo.png' %}" alt="CHRIST University" class="logo-img">
          <span class="app-name">Event Management Suite</span>
        </div>
      </div>

      <!-- (Search removed) -->

      <div class="utility-right" style="display: flex; align-items: center; gap: 1.5rem;">
        <div class="notification-section">
          <button class="utility-btn notification-btn" id="notificationBtn" aria-label="Notifications" aria-haspopup="true" aria-expanded="false" style="position:relative;">
            <i class="fa fa-bell notification-icon" style="font-size:1.5rem;color:#d4af37;"></i>
            {% if notifications and notifications|length > 0 %}
            <span class="notification-badge" id="notificationBadge" style="position:absolute;top:2px;right:2px;min-width:18px;padding:2px 6px;border-radius:10px;background:#ef4444;color:#fff;font-size:0.75rem;font-weight:700;text-align:center;z-index:2;">{{ notifications|length }}</span>
            {% endif %}
          </button>
          <div class="notification-dropdown" id="notificationDropdown" style="position:fixed;top:70px;right:1.5rem;width:340px;max-width:95vw;background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 8px 32px rgba(44,90,160,0.13);opacity:0;visibility:hidden;transform:translateY(-10px);transition:all 0.22s cubic-bezier(.4,0,.2,1);z-index:20000;overflow:hidden;">
            <div class="notification-header" style="display:flex;align-items:center;justify-content:space-between;padding:1rem 1.25rem;background:#f9fafb;border-bottom:1px solid #e5e7eb;">
              <h3 style="margin:0;font-size:1.1rem;font-weight:700;color:#2c5aa0;letter-spacing:.01em;">Notifications</h3>
              {% if notifications and notifications|length > 0 %}
              <button class="mark-all-read" id="markAllRead" style="border-radius:6px;padding:2px 12px;font-size:0.85rem;font-weight:600;background:#f3f4f6;color:#2c5aa0;border:1px solid #2c5aa0;transition:background 0.2s, color 0.2s;cursor:pointer;">
                <i class="fa fa-check-double" style="margin-right:4px;"></i> Mark all read
              </button>
              {% endif %}
            </div>
            <div class="notification-list" id="notificationList" style="max-height:340px;overflow-y:auto;">
              {% if notifications and notifications|length > 0 %}
                {% for notification in notifications %}
                <div class="notification-item {% if not notification.is_read %}unread{% endif %}" style="display:flex;gap:.85rem;padding:.95rem 1.25rem;border-bottom:1px solid #f3f4f6;{% if not notification.is_read %}background:#f3f4f6;{% endif %}">
                  <div class="notification-icon" style="width:36px;height:36px;border-radius:50%;display:grid;place-items:center;background:#e8f0f9;color:#2c5aa0;font-size:1.2rem;">
                    <i class="fa fa-{{ notification.icon|default:'bell' }}"></i>
                  </div>
                  <div class="notification-content" style="flex:1;min-width:0;">
                    <div class="notification-title" style="font-weight:600;font-size:1rem;color:#1f2937;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">{{ notification.title }}</div>
                    <div class="notification-text" style="font-size:.93rem;color:#374151;white-space:normal;word-break:break-word;">{{ notification.message }}</div>
                    <div class="notification-time" style="font-size:.8rem;color:#6b7280;margin-top:2px;">{{ notification.created_at|timesince }} ago</div>
                  </div>
                </div>
                {% endfor %}
              {% else %}
              <div class="notification-item" style="padding:2.5rem 1.25rem;text-align:center;color:#6b7280;background:#f9fafb;">
                <div class="notification-title" style="font-weight:600;font-size:1.05rem;">No notifications</div>
                <div class="notification-text" style="font-size:.93rem;">You're all caught up!</div>
              </div>
              {% endif %}
            </div>
            {% if notifications and notifications|length > 0 %}
            <div class="notification-footer">
              <a href="/notifications/" class="view-all-link">View all notifications</a>

            <div class="notification-footer" style="padding:.7rem 1.25rem;background:#f9fafb;border-top:1px solid #e5e7eb;text-align:right;">
              <a href="/core-admin/notifications/" class="view-all-link" style="color:#2c5aa0;font-weight:600;font-size:.95rem;text-decoration:underline;">View all notifications</a>

            </div>
            {% endif %}
          </div>
          <style>
            .notification-dropdown.active{opacity:1!important;visibility:visible!important;transform:translateY(0)!important;}
            .notification-item.unread .notification-title{color:#2c5aa0;}
            .mark-all-read:hover{background:#2c5aa0!important;color:#fff!important;}
          </style>
        </div>
        <div class="profile-section">
          <button class="profile-btn" aria-label="Profile">
            <div class="profile-avatar">
              {{ request.user.get_full_name|default:request.user.username|slice:":1"|upper }}
            </div>
            <span class="profile-name">{{ request.user.get_full_name|default:request.user.username }}</span>
            <i class="fas fa-chevron-down"></i>
          </button>
          <div class="profile-dropdown">
            <div class="dropdown-header">
              <div class="user-info">
                <strong>{{ request.user.get_full_name|default:request.user.username }}</strong>
                <small>{{ request.session.role|default:"User" }}</small>
              </div>
            </div>
            <div class="dropdown-divider"></div>
            <a href="{% url 'my_profile' %}" class="dropdown-item">
              <i class="fas fa-user"></i> My Profile
            </a>
            
            <a href="{% url 'logout' %}" class="dropdown-item">
              <i class="fas fa-sign-out-alt"></i> Logout
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if has_sidebar %}
  <!-- ZONE 2: LEFT CONTROL PANEL -->
  <div class="left-control-panel">
    <nav class="control-navigation">
      
  {% if unrestricted_nav or 'dashboard' in allowed_nav_items %}
      <!-- Dashboard - Always Visible -->
      <div class="nav-item">
  {% if unrestricted_nav %}
        <a href="{% url 'admin_dashboard' %}" class="nav-link {% if request.resolver_match.url_name == 'admin_dashboard' %}active{% endif %}">
          <i class="fas fa-chart-pie nav-icon"></i>
          <span class="nav-text">Dashboard</span>
        </a>
        {% else %}
        <a href="{% url 'dashboard' %}" class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
          <i class="fas fa-chart-pie nav-icon"></i>
          <span class="nav-text">Dashboard</span>
        </a>
        {% endif %}
      </div>
      {% endif %}

  {% if unrestricted_nav or 'events' in allowed_nav_items %}
      <!-- Event Management Suite - Expandable -->
      <div class="nav-section {% if 'suite' in request.resolver_match.url_name or '/suite/' in request.path or request.resolver_match.namespace == 'emt' %}expanded{% endif %}">
        <div class="nav-section-header">
          <i class="fas fa-clipboard-list nav-icon"></i>
          <span class="nav-text">Event Management Suite</span>
          <i class="fas fa-chevron-right expand-icon {% if 'suite' in request.resolver_match.url_name or '/suite/' in request.path or request.resolver_match.namespace == 'emt' %}rotated{% endif %}"></i>
        </div>
        <div class="nav-submenu {% if 'suite' in request.resolver_match.url_name or '/suite/' in request.path or request.resolver_match.namespace == 'emt' %}open{% endif %}">
          <a href="/suite/submit/" class="nav-sublink {% if request.resolver_match.url_name == 'submit_proposal' %}active{% endif %}">
            <i class="fas fa-edit"></i> Event Proposal
          </a>
          <a href="/suite/pending-reports/" class="nav-sublink {% if request.resolver_match.url_name == 'pending_reports' %}active{% endif %}">
            <i class="fas fa-chart-bar"></i> Report Generation
          </a>
          <a href="/suite/generated-reports/" class="nav-sublink {% if request.resolver_match.url_name == 'generated_reports' %}active{% endif %}">
            <i class="fas fa-eye"></i> View Reports
          </a>
          {% if unrestricted_nav or 'my_approvals' in allowed_nav_items %}
          <a href="{% url 'emt:my_approvals' %}" class="nav-sublink {% if request.resolver_match.url_name == 'my_approvals' %}active{% endif %}">
            <i class="fas fa-check-circle"></i> Event Approvals
          </a>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <!-- Graduate Transcript - Standalone (Admin-controlled) -->
  {% if unrestricted_nav or 'transcript' in allowed_nav_items %}
      <div class="nav-item">
        <a href="/transcript/" class="nav-link {% if request.resolver_match.namespace == 'transcript' or 'transcript' in request.resolver_match.url_name or '/transcript/' in request.path %}active{% endif %}">
          <i class="fas fa-graduation-cap nav-icon"></i>
          <span class="nav-text">Graduate Transcript</span>
        </a>
      </div>
      {% endif %}

      <!-- CDL Support - Single link (no submenu) -->
  {% if unrestricted_nav or 'cdl' in allowed_nav_items %}
      <div class="nav-item">
        <a href="/cdl/user-view/" class="nav-link {% if request.resolver_match and request.resolver_match.url_name == 'cdl_event_user_view' %}active{% endif %}">
          <i class="fas fa-photo-video nav-icon"></i>
          <span class="nav-text">CDL Support</span>
        </a>
      </div>
      <div class="nav-item">
        <a href="/cdl/analysis/" class="nav-link {% if request.resolver_match and request.resolver_match.url_name == 'cdl_analysis_page' %}active{% endif %}">
          <i class="fas fa-chart-line nav-icon"></i>
          <span class="nav-text">Analysis</span>
        </a>
      </div>
  {% endif %}

      <!-- User Management - Expandable (Admin Only) -->
  {% if unrestricted_nav or 'user_management' in allowed_nav_items %}
<div class="nav-section {% if 'users' in request.path or 'user-roles' in request.path or request.resolver_match.url_name == 'admin_user_management' or request.resolver_match.url_name == 'admin_role_management' or request.resolver_match.url_name == 'admin_user_panel' %}expanded{% endif %}">
  <div class="nav-section-header">
    <i class="fas fa-users nav-icon"></i>
    <span class="nav-text">User Management</span>
    <i class="fas fa-chevron-right expand-icon {% if 'users' in request.path or 'user-roles' in request.path or request.resolver_match.url_name == 'admin_user_management' or request.resolver_match.url_name == 'admin_role_management' or request.resolver_match.url_name == 'admin_user_panel' %}rotated{% endif %}"></i>
  </div>
  <div class="nav-submenu {% if 'users' in request.path or 'user-roles' in request.path or request.resolver_match.url_name == 'admin_user_management' or request.resolver_match.url_name == 'admin_role_management' or request.resolver_match.url_name == 'admin_user_panel' %}open{% endif %}">
    <a href="/core-admin/users/" class="nav-sublink {% if request.resolver_match.url_name == 'admin_user_management' or request.resolver_match.url_name == 'admin_user_panel' %}active{% endif %}">
      <i class="fas fa-user"></i> Manage Users
    </a>
    <a href="/core-admin/user-roles/" class="nav-sublink {% if request.resolver_match.url_name == 'admin_role_management' %}active{% endif %}">
      <i class="fas fa-tags"></i> Add Roles
    </a>
  </div>
</div>
{% endif %}


      <!-- Event Proposals - Standalone (Admin Only) -->
  {% if unrestricted_nav or 'event_proposals' in allowed_nav_items %}
        <div class="nav-item">
          <a href="/core-admin/event-proposals/" class="nav-link {% if request.resolver_match.url_name == 'admin_event_proposals' %}active{% endif %}">
            <i class="fas fa-list nav-icon"></i>
            <span class="nav-text">Event Proposals</span>
          </a>
        </div>
      {% endif %}



      <!-- Reports - Standalone (Admin Only) -->
  {% if unrestricted_nav %}
      <div class="nav-item">
        <a href="/core-admin/reports/" class="nav-link {% if request.resolver_match.url_name == 'admin_reports' or request.resolver_match.url_name == 'admin_reports_view' %}active{% endif %}">
          <i class="fas fa-file-alt nav-icon"></i>
          <span class="nav-text">Reports</span>
        </a>
      </div>
      {% endif %}

      <!-- Settings - Expandable (Admin Only) -->
  {% if unrestricted_nav or 'settings' in allowed_nav_items %}
  <div class="nav-section {% if 'settings' in request.path %}expanded{% endif %}">
    <div class="nav-section-header">
      <i class="fas fa-cog nav-icon"></i>
      <span class="nav-text">Settings</span>
      <i class="fas fa-chevron-right expand-icon {% if 'settings' in request.path %}rotated{% endif %}"></i>
    </div>
    <div class="nav-submenu {% if 'settings' in request.path %}open{% endif %}">

  {% if unrestricted_nav or 'user_settings' in allowed_nav_items %}
      <a href="{% url 'admin_master_data' %}" class="nav-sublink {% if request.resolver_match.url_name == 'admin_master_data' %}active{% endif %}">
        <i class="fas fa-user-cog"></i> User Settings
      </a>
      {% endif %}

  {% if unrestricted_nav or 'approval_flow' in allowed_nav_items %}
      <a href="{% url 'admin_approval_flow' %}" class="nav-sublink {% if request.resolver_match.url_name == 'admin_approval_flow' %}active{% endif %}">
        <i class="fas fa-route"></i> Approval Flow
      </a>
      {% endif %}

  {% if unrestricted_nav or 'pso_psos' in allowed_nav_items %}
      <a href="{% url 'admin_pso_po_management' %}" class="nav-sublink {% if request.resolver_match.url_name == 'admin_pso_po_management' %}active{% endif %}">
        <i class="fas fa-clipboard-list"></i> POs & PSOs Management
      </a>
      {% endif %}

  {% if unrestricted_nav or 'academic_year' in allowed_nav_items %}
      <a href="{% url 'admin_academic_year_settings' %}" class="nav-sublink {% if request.resolver_match.url_name == 'admin_academic_year_settings' %}active{% endif %}">
        <i class="fas fa-calendar-alt"></i> Academic Year
      </a>
      {% endif %}

  {% if unrestricted_nav or 'history' in allowed_nav_items %}
      <a href="{% url 'admin_history' %}" class="nav-sublink {% if request.resolver_match.url_name == 'admin_history' %}active{% endif %}">
        <i class="fas fa-history"></i> History
      </a>
      {% endif %}

  {% if unrestricted_nav or 'sidebar_permissions' in allowed_nav_items %}
      <a href="{% url 'admin_sidebar_permissions' %}" class="nav-sublink {% if request.resolver_match.url_name == 'admin_sidebar_permissions' %}active{% endif %}">
        <i class="fas fa-bars"></i> Sidebar Permissions
      </a>
      {% endif %}

    </div>
  </div>
{% endif %}


      {% if request.user.is_staff or request.user.is_superuser %}
      <div class="json-controls" style="position: fixed; bottom: 0; left: 0; width: 280px; padding: 6px; background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(8px); border-top: 1px solid rgba(229, 231, 235, 0.3); z-index: 100;">
        <div style="display: flex; gap: 4px;">
          <button id="download-json-btn" class="json-btn" style="flex: 1; padding: 4px; border-radius: 4px; border: 1px solid rgba(229, 231, 235, 0.4); background: rgba(248, 250, 252, 0.4); color: rgba(55, 65, 81, 0.65); font-size: 0.7rem; display: flex; align-items: center; justify-content: center; gap: 3px; min-height: 24px; transition: all 0.2s ease;">
            <i class="fas fa-download" style="font-size: 0.7rem; opacity: 0.5;"></i> JSON
          </button>
          <label for="upload-json-input" class="json-btn" style="flex: 1; padding: 4px; border-radius: 4px; border: 1px solid rgba(229, 231, 235, 0.4); background: rgba(248, 250, 252, 0.4); color: rgba(55, 65, 81, 0.65); font-size: 0.7rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 3px; min-height: 24px; transition: all 0.2s ease;">
            <i class="fas fa-upload" style="font-size: 0.7rem; opacity: 0.5;"></i> JSON
          </label>
          <input type="file" id="upload-json-input" accept=".json" style="display: none;">
        </div>
      </div>

      <style>
        .json-btn:hover { background: rgba(248, 250, 252, 0.8) !important; color: rgba(55, 65, 81, 0.9) !important; border-color: rgba(229, 231, 235, 0.6) !important; }
        .json-btn:hover i { opacity: 0.8 !important; }
      </style>
      {% endif %}

    </nav>
  </div>
  {% endif %}

  <!-- ZONE 3: MAIN VIEWSCREEN -->
  <div class="main-viewscreen main-content">
    <div class="viewscreen-content">
      <script>
        // Expose a helper for future live-updates of the sidebar
        window.refreshSidebar = async function(){
          try{
            const r = await fetch('{% url "api_my_sidebar" %}', {headers:{'X-Requested-With':'fetch'}});
            if(r.ok){ location.reload(); }
          }catch(e){}
        };
      </script>
      {% block content %}
      <div class="welcome-screen">
        <h1>Welcome to IQAC Command Center</h1>
        <p>Select an option from the left panel to begin.</p>
      </div>
      {% endblock %}
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

  <!-- JavaScript for interactions (search removed) -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const toasts = document.querySelectorAll('.toast-message');
      toasts.forEach(toast => {
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => toast.classList.add('hide'), 5000);
        setTimeout(() => toast.remove(), 5500);
      });

      // Profile dropdown toggle
      const profileBtn = document.querySelector('.profile-btn');
      if (profileBtn) {
        profileBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          document.querySelector('.profile-dropdown').classList.toggle('active');
        });
      }

      // Notification dropdown toggle
      const notificationBtn = document.getElementById('notificationBtn');
      const notificationDropdown = document.getElementById('notificationDropdown');
      const markAllReadBtn = document.getElementById('markAllRead');

      if (notificationBtn && notificationDropdown) {
        notificationBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          const expanded = notificationDropdown.classList.toggle('active');
          notificationBtn.setAttribute('aria-expanded', expanded);

          // Close profile dropdown if open
          const profileDropdown = document.querySelector('.profile-dropdown');
          if (profileDropdown) profileDropdown.classList.remove('active');
        });

        // Mark all as read functionality
        if (markAllReadBtn) {
          markAllReadBtn.addEventListener('click', function() {
            const unreadItems = document.querySelectorAll('.notification-item.unread');
            unreadItems.forEach(item => item.classList.remove('unread'));
            const badge = document.getElementById('notificationBadge');
            if (badge) badge.style.display = 'none';
          });
        }
      }

      // Navigation section expand/collapse
      const navHeaders = document.querySelectorAll('.nav-section-header');
      navHeaders.forEach(header => {
        header.addEventListener('click', function() {
          const section = this.parentElement;
          const submenu = section.querySelector('.nav-submenu');
          const icon = this.querySelector('.expand-icon');
          if (section.classList.contains('expanded')) {
            section.classList.remove('expanded');
            if (submenu) submenu.classList.remove('open');
            if (icon) icon.classList.remove('rotated');
          } else {
            section.classList.add('expanded');
            if (submenu) submenu.classList.add('open');
            if (icon) icon.classList.add('rotated');
          }
        });
      });

      // Sidebar toggle (hamburger)
      const sidebarToggle = document.getElementById('sidebarToggle');
      sidebarToggle?.addEventListener('click', function(){
        document.body.classList.toggle('sidebar-collapsed');
      });

      // Close dropdowns when clicking outside
      document.addEventListener('click', function(e) {
        const profileDropdown = document.querySelector('.profile-dropdown');
        if (profileDropdown && !e.target.closest('.profile-section')) profileDropdown.classList.remove('active');

        const notificationDropdown = document.getElementById('notificationDropdown');
        if (notificationDropdown && !e.target.closest('.notification-section')) {
          notificationDropdown.classList.remove('active');
          if (notificationBtn) notificationBtn.setAttribute('aria-expanded', false);
        }
      });
    });
  </script>

  <script src="{% static 'emt/js/json_sync.js' %}"></script>
  {% block scripts %}{% endblock %}
  {% block scripts_extra %}{% endblock %}
</body>
{% endwith %}
</html>
