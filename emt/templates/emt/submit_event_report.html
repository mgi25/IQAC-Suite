{% extends "base.html" %}
{% load static %}

{% block title %}Event Report Dashboard{% endblock %}

{% block head_extra %}
    <link rel="stylesheet" href="{% static 'emt/css/styles.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet"/>
{% endblock %}

{% block content %}
<div class="proposal-layout">
    <nav class="proposal-nav">
        <div class="nav-header">
            <h2 class="nav-title">Event Report</h2>
            <p class="nav-subtitle">Complete all sections to submit</p>
        </div>
        <ul class="nav-items">
            <li class="nav-item">
                <a href="#" class="nav-link active" data-section="event-information" data-order="1">
                    <span class="nav-number">1</span>
                    <div class="nav-content">
                        <div class="nav-item-title">Event Information</div>
                        <div class="nav-item-subtitle">Basic event details and metadata</div>
                    </div>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link disabled" data-section="participants-information" data-order="2">
                    <span class="nav-number">2</span>
                    <div class="nav-content">
                        <div class="nav-item-title">Participants Information</div>
                        <div class="nav-item-subtitle">Attendees, speakers, organizing committee</div>
                    </div>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link disabled" data-section="event-summary" data-order="3">
                    <span class="nav-number">3</span>
                    <div class="nav-content">
                        <div class="nav-item-title">Summary of Overall Event</div>
                        <div class="nav-item-subtitle">Comprehensive event overview (min 500 words)</div>
                    </div>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link disabled" data-section="event-outcomes" data-order="4">
                    <span class="nav-number">4</span>
                    <div class="nav-content">
                        <div class="nav-item-title">Outcomes of the Event</div>
                        <!-- removed post-event label per unified CDL user flow -->
                    </div>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link disabled" data-section="analysis" data-order="5">
                    <span class="nav-number">5</span>
                    <div class="nav-content">
                        <div class="nav-item-title">Analysis</div>
                        <div class="nav-item-subtitle">Detailed analysis and insights (min 500 words)</div>
                    </div>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link disabled" data-section="event-relevance" data-order="6">
                    <span class="nav-number">6</span>
                    <div class="nav-content">
                        <div class="nav-item-title">Relevance of the Event</div>
                        <div class="nav-item-subtitle">POs, PSOs, graduate attributes, SDGs</div>
                    </div>
                </a>
            </li>
        </ul>
    </nav>

    <main class="proposal-content">
        <div class="content-header">
            <h1 class="content-title" id="main-title">Event Information</h1>
            <p class="content-subtitle" id="main-subtitle">Basic event details fetched from proposal</p>
        </div>

        {% if form.errors %}
            <div class="form-errors-banner">
                <strong>Please fix the following errors:</strong>
                <ul>
                    {% for field, errors in form.errors.items %}
                        {% for error in errors %}
                            <li>{{ field }}: {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                </ul>
            </div>
        {% endif %}

        <form method="post" enctype="multipart/form-data" id="report-form" autocomplete="off" action="{% url 'emt:submit_event_report' proposal.id %}" data-preview-url="{% url 'emt:preview_event_report' proposal.id %}">
            {% csrf_token %}
            <textarea name="event_summary" hidden>{{ event_summary.content|default_if_none:'' }}</textarea>
            <textarea name="event_outcomes" hidden>{{ event_outcomes.content|default_if_none:'' }}</textarea>
            <textarea name="analysis" hidden>{{ analysis.content|default_if_none:'' }}</textarea>
            <textarea name="attendance_notes" id="attendance-data" hidden>{{ form.attendance_notes.value|default:'' }}</textarea>

            <div class="form-panel" id="form-panel">
                <div class="form-panel-content" id="form-panel-content">
                    <div class="form-grid">
                        <!-- Organization Information Section -->
                        <div class="form-section-header">
                            <h3>Organization Details</h3>
                        </div>
                        
                        <div class="form-row">
                            <div class="input-group">
                                <label for="department-modern">Department *</label>
                                <input type="text" id="department-modern" name="department" class="proposal-input" value="{{ proposal.organization.name|default:'' }}">
                                <div class="help-text">Department from original proposal (editable)</div>
                            </div>
                            <div class="input-group">
                                <label for="location-modern">Venue/Location *</label>
                                <input type="text" id="location-modern" name="venue" class="proposal-input" value="{{ proposal.venue|default:'' }}">
                                <div class="help-text">Venue from original proposal (editable)</div>
                            </div>
                        </div>

                        <!-- Event Information Section -->
                        <div class="form-section-header">
                            <h3>Event Information</h3>
                        </div>

                        <div class="form-row full-width">
                            <div class="input-group">
                                <label for="event-title-modern">Event Title *</label>
                                <input type="text" id="event-title-modern" name="event_title" class="proposal-input" value="{{ proposal.event_title|default:'' }}">
                                <div class="help-text">Event title from proposal (editable)</div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="input-group">
                                <label for="venue-modern">Venue *</label>
                                <input type="text" id="venue-modern" name="venue_detail" class="proposal-input" value="{{ proposal.venue|default:'' }}">
                                <div class="help-text">Venue from proposal (editable)</div>
                            </div>
                        </div>

                        <!-- Schedule & Academic Information Section -->
                        <div class="form-section-header">
                            <h3>Schedule & Academic Information</h3>
                        </div>

                        <div class="form-row">
                            <div class="input-group">
                                <label for="start-date-modern">Event Start Date *</label>
                                <input type="date" id="start-date-modern" name="event_start_date" class="proposal-input" value="{% if proposal.event_start_date %}{{ proposal.event_start_date|date:'Y-m-d' }}{% elif proposal.event_datetime %}{{ proposal.event_datetime|date:'Y-m-d' }}{% endif %}">
                                <div class="help-text">Start date from original proposal (editable)</div>
                            </div>
                            <div class="input-group">
                                <label for="end-date-modern">Event End Date *</label>
                                <input type="date" id="end-date-modern" name="event_end_date" class="proposal-input" value="{% if proposal.event_end_date %}{{ proposal.event_end_date|date:'Y-m-d' }}{% elif proposal.event_datetime %}{{ proposal.event_datetime|date:'Y-m-d' }}{% endif %}">
                                <div class="help-text">End date from original proposal (editable)</div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="input-group">
                                <label for="academic-year-modern">Academic Year *</label>
                                <input type="text" id="academic-year-modern" class="proposal-input" value="{{ proposal.academic_year|default:'2024-2025' }}" disabled>
                                <input type="hidden" name="academic_year" value="{{ proposal.academic_year|default:'2024-2025' }}">
                                <div class="help-text">Academic year from proposal (not editable)</div>
                            </div>
                            <div class="input-group">
                                <label for="event-type-modern">Event Type *</label>
                                <input type="text" id="event-type-modern" name="actual_event_type" class="proposal-input" value="{{ form.actual_event_type.value|default:proposal.event_focus_type }}" readonly>
                                {% if form.actual_event_type.errors %}
                                    <div class="field-error">{{ form.actual_event_type.errors.0 }}</div>
                                {% endif %}
                                <div class="help-text">Event type from proposal (not editable)</div>
                            </div>
                        </div>

                        <!-- Additional Information Section -->
                        <div class="form-section-header">
                            <h3>Additional Information</h3>
                        </div>

                        <div class="form-row">
                            <div class="input-group">
                                <label for="actual-location-modern">Actual Event Location</label>
                                <input type="text" id="actual-location-modern" name="location" class="proposal-input" value="{{ form.location.value|default:proposal.venue|default:'' }}" placeholder="Enter the actual venue where event was held">
                                <div class="help-text">Specify the actual venue (if different from proposed venue)</div>
                                {% if form.location.errors %}
                                    <div class="field-error">{{ form.location.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="input-group">
                                <label for="blog-link-modern">Blog Link</label>
                                <input type="url" id="blog-link-modern" name="blog_link" class="proposal-input" value="{{ form.blog_link.value|default:'' }}" placeholder="https://example.com/blog-post">
                                <div class="help-text">Optional: Link to blog post or article about the event</div>
                                {% if form.blog_link.errors %}
                                    <div class="field-error">{{ form.blog_link.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="input-group">
                                <label for="attendance-modern">Attendance *</label>
                                <input type="text" id="attendance-modern" class="proposal-input" readonly value="Present: {{ attendance_present }}, Absent: {{ attendance_absent }}, Volunteers: {{ attendance_volunteers }}" {% if report %}data-attendance-url="{% url 'emt:attendance_upload' report.id %}"{% endif %}>
                                <input type="hidden" id="num-participants-modern" name="num_participants" value="{{ attendance_counts.total|default_if_none:'' }}">
                                <div class="help-text">Click attendance box to manage via CSV</div>
                                {% if form.num_participants.errors %}
                                    <div class="field-error">{{ form.num_participants.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="input-group">
                                <label for="num-volunteers-modern">Number of student volunteers</label>
                                <input type="number" id="num-volunteers-modern" class="proposal-input" value="{{ attendance_counts.volunteers|default_if_none:'' }}" disabled>
                                <input type="hidden" id="num-volunteers-hidden" name="num_student_volunteers" value="{{ attendance_counts.volunteers|default_if_none:'' }}">
                                <div class="help-text">Automatically calculated from attendance CSV</div>
                                {% if form.num_student_volunteers.errors %}
                                    <div class="field-error">{{ form.num_student_volunteers.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="input-group">
                                <label for="student-participants-modern">Number of student participants</label>
                                <input type="number" id="student-participants-modern" name="num_student_participants" class="proposal-input" value="{{ attendance_counts.students|default_if_none:'' }}">
                                {% if form.num_student_participants.errors %}
                                    <div class="field-error">{{ form.num_student_participants.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="input-group">
                                <label for="faculty-participants-modern">Number of faculty participants</label>
                                <input type="number" id="faculty-participants-modern" name="num_faculty_participants" class="proposal-input" value="{{ attendance_counts.faculty|default_if_none:'' }}">
                                {% if form.num_faculty_participants.errors %}
                                    <div class="field-error">{{ form.num_faculty_participants.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="input-group">
                                <label for="external-participants-modern">Number of external participants</label>
                                <input type="number" id="external-participants-modern" name="num_external_participants" class="proposal-input" value="{{ attendance_counts.external|default_if_none:'' }}">
                                {% if form.num_external_participants.errors %}
                                    <div class="field-error">{{ form.num_external_participants.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Activities Section -->
                        <div class="form-section-header">
                            <h3>Activities Planning</h3>
                        </div>

                        <div class="form-row">
                            <div class="input-group">
                                <label for="num-activities-modern">Number of Activities</label>
                                <input type="number" id="num-activities-modern" name="num_activities" class="proposal-input" min="1" max="50" value="{{ proposal_activities|length }}" placeholder="Enter number of activities">
                                <div class="help-text">How many activities will your event include?</div>
                            </div>
                        </div>

                        <!-- Dynamic activities section -->
                        <div id="dynamic-activities-section" class="full-width">
                            {% for act in proposal_activities %}
                            <div class="activity-row">
                                <div class="input-group">
                                    <label for="activity_name_{{ forloop.counter }}" class="activity-label">{{ forloop.counter }}. Activity Name</label>
                                    <input type="text" id="activity_name_{{ forloop.counter }}" name="activity_name_{{ forloop.counter }}" class="proposal-input" value="{{ act.activity_name }}">
                                </div>
                                <div class="input-group">
                                    <label for="activity_date_{{ forloop.counter }}" class="date-label">{{ forloop.counter }}. Activity Date</label>
                                    <input type="date" id="activity_date_{{ forloop.counter }}" name="activity_date_{{ forloop.counter }}" class="proposal-input" value="{{ act.activity_date }}">
                                </div>
                                <button type="button" class="remove-activity btn btn-sm btn-outline-danger">×</button>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Save Section -->
                        <div class="form-row full-width">
                            <div class="save-section-container">
                                <button type="button" class="btn-save-section">Save & Continue</button>
                                <div class="save-help-text">Complete this section to unlock the next one</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="submit-section hidden">
                <button type="submit" name="final_submit" class="btn-submit" id="submit-report-btn" disabled>Submit Report</button>
                <div class="submit-help-text">Complete all sections above to enable submission</div>
            </div>

            <div style="display: none;" id="django-forms">
                <!-- Include all remaining Django form fields that aren't shown in the UI -->
                {% for field in form %}
                    {# Use explicit comparisons to avoid substring-matching bug #}
                    {% if field.name != 'blog_link' and field.name != 'location' and field.name != 'num_participants' and field.name != 'num_student_volunteers' and field.name != 'actual_event_type' %}
                        {{ field }}
                    {% endif %}
                {% endfor %}
            </div>
        </form>
    </main>
</div>

<div class="autosave-indicator" id="autosave-indicator">
    <span class="indicator-text">Saved</span>
</div>

<!-- SDG Goals Modal -->
<div id="sdgModal" class="sdg-modal">
    <div class="sdg-modal-content">
        <h3>Select SDG Goals</h3>
        <p>Choose the Sustainable Development Goals that this event addresses:</p>
        <div id="sdgOptions" class="sdg-options">
            <!-- SDG options will be populated here -->
        </div>
        <div class="modal-actions" style="margin-top: 20px; text-align: center;">
            <button type="button" id="sdgCancel" class="btn-draft-section" style="margin-right: 10px;">Cancel</button>
            <!-- Removed 'btn-save-section' to prevent triggering the global Save & Continue handler -->
            <button type="button" id="sdgSave" class="btn-sdg-save" style="min-width:140px;">Save Selection</button>
        </div>
    </div>
</div>

<!-- Outcomes (PO/PSO) Modal -->
<div id="outcomeModal" class="sdg-modal" data-url="">
    <div class="sdg-modal-content">
        <h3>Select Program Outcomes (PO) and Program Specific Outcomes (PSO)</h3>
        <p>Select all that apply to this event. Your current selections will be preserved on reopen.</p>
        <div id="outcomeOptions" class="sdg-options outcome-options" data-empty-text="No outcomes available.">
            <!-- Outcome options populated via JS -->
        </div>
        <div class="modal-actions" style="margin-top: 20px; text-align: center;">
            <button type="button" id="outcomeCancel" class="btn-draft-section" style="margin-right: 10px;">Cancel</button>
            <button type="button" id="outcomeSave" class="btn-outcome-save" style="min-width:140px;">Save Selection</button>
        </div>
    </div>
    <style>
        /* Reuse SDG modal styling */
        #outcomeModal.sdg-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.35); z-index: 1000; }
        #outcomeModal.sdg-modal.show { display: block; }
    </style>
</div>

<div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <p>Loading...</p>
</div>

{% endblock %}

{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script>
        // Corrected jQuery fallback with safe quoting
        if (!window.jQuery) {
            document.write("<script src=\"{% static 'emt/js/jquery-3.7.1.min.js' %}\"><\\/script>");
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <!-- Fallback inline JSON payload for proposal speakers -->
    <script type="application/json" id="proposal-speakers-json">{{ speakers_json|default:'[]'|safe }}</script>
    <script>
        // Global variables for the Event Report Form
        window.REPORT_ID = "{{ report.id|default:''|escapejs }}";
        window.PROPOSAL_ID = "{{ proposal.id|default:''|escapejs }}";
        window.REPORT_STATUS = "{{ report.status|default:'draft'|escapejs }}";
        window.CAN_AUTOSAVE = {{ can_autosave|yesno:"true,false" }};
        window.REPORT_ACTUAL_EVENT_TYPE = "{{ form.actual_event_type.value|default:''|escapejs }}";
        window.AUTOSAVE_URL = "{% url 'emt:autosave_event_report' %}";
        window.AUTOSAVE_CSRF = "{{ csrf_token }}";
    window.API_ORGANIZATIONS = "#"; // TODO: Add API URLs (not used on this page)
        window.API_CLASSES_BASE = "{% url 'emt:api_classes' 0 %}".split('0/')[0];
        window.API_FACULTY = "{% url 'emt:api_faculty' %}";
        window.PROPOSAL_ORG_ID = "{{ proposal.organization.id|default:''|escapejs }}";
        window.PROPOSAL_ORG_NAME = "{{ proposal.organization.name|default:''|escapejs }}";
    window.API_OUTCOMES_BASE = "{% url 'emt:api_outcomes' 0 %}".split('0/')[0];
    window.GA_EDIT_BASE = "{% url 'emt:graduate_attributes_edit' 0 %}".split('0/')[0];
        window.SDG_GOALS = {{ sdg_goals_list|default:'[]'|safe }};
        window.PROPOSAL_ACTIVITIES = {{ proposal_activities_json|safe }};
        window.EXISTING_SPEAKERS = {{ speakers_json|default:'[]'|safe }};
        window.SPEAKER_UPDATE_BASE = "{% url 'emt:api_update_speaker' proposal.id 0 %}".split('0/')[0];
        window.ATTENDANCE_PRESENT = {{ attendance_present|default:0 }};
        window.ATTENDANCE_ABSENT = {{ attendance_absent|default:0 }};
        window.ATTENDANCE_VOLUNTEERS = {{ attendance_volunteers|default:0 }};
        window.ATTENDANCE_COUNTS = {{ attendance_counts_json|default:'{}'|safe }};
    // Current saved Graduate Attributes mapping (for reliable summary hydration)
    window.REPORT_GA_MAPPING = "{{ report.needs_grad_attr_mapping|default:''|escapejs }}";
        window.PROPOSAL_DATA = {
            department: "{{ proposal.organization.name|default:''|escapejs }}",
            venue: "{{ proposal.venue|default:''|escapejs }}",
            title: "{{ proposal.event_title|default:''|escapejs }}",
            target_audience: "{{ proposal.target_audience|default:''|escapejs }}",
            event_focus_type: "{{ proposal.event_focus_type|default:''|escapejs }}",
            student_coordinators: "{{ proposal.student_coordinators|default:''|escapejs }}",
            proposer: "{{ proposal.submitted_by.get_full_name|default:''|escapejs }}",
            faculty_incharges: {{ faculty_names_json|default:'[]'|safe }},
            volunteers: {{ volunteer_names_json|default:'[]'|safe }},
            academic_year: "{{ proposal.academic_year|default:'2024-2025'|escapejs }}",
            num_activities: "{{ proposal_activities|length|escapejs }}",
            event_start_date: "{% if proposal.event_start_date %}{{ proposal.event_start_date|date:'Y-m-d'|escapejs }}{% elif proposal.event_datetime %}{{ proposal.event_datetime|date:'Y-m-d'|escapejs }}{% endif %}",
            event_end_date: "{% if proposal.event_end_date %}{{ proposal.event_end_date|date:'Y-m-d'|escapejs }}{% elif proposal.event_datetime %}{{ proposal.event_datetime|date:'Y-m-d'|escapejs }}{% endif %}",
            activities: {{ proposal_activities_json|default:'[]'|safe }},
            speakers: {{ speakers_json|default:'[]'|safe }},
            pos_pso: "{{ proposal.pos_pso|default:''|escapejs }}",
            sdg_goals: "{{ proposal_sdg_goals|default:''|escapejs }}"
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="{% static 'emt/js/report_autosave.js' %}"></script>
    <script src="{% static 'emt/js/submit_event_report.js' %}"></script>
    <script>
        // Lightweight page-only wiring for Attendance and GA buttons without touching core JS
        (function(){
            document.addEventListener('DOMContentLoaded', function(){
                // Attendance click: open upload page if report exists
                var att = document.getElementById('attendance-modern');
                if (att) {
                    att.style.cursor = 'pointer';
                    att.addEventListener('click', function(){
                        var url = att.getAttribute('data-attendance-url');
                        if (!url) { return; }
                        window.location.href = url;
                    });
                }

                // GA editor button
                document.addEventListener('click', function(e){
                    if (e.target && e.target.id === 'ga-open-editor-btn') {
                        var rid = window.REPORT_ID;
                        // Build correct GA editor URL: /reports/<id>/graduate-attributes/edit/
                        var go = function(id){
                            if (!window.GA_EDIT_BASE) return;
                            // Append ?from=ga to prevent progress reset and refresh GA summary on return
                            window.location.href = window.GA_EDIT_BASE + id + '/graduate-attributes/edit/?from=ga';
                        };
                        if (!rid) {
                            if (window.ReportAutosaveManager && window.ReportAutosaveManager.manualSave) {
                                window.ReportAutosaveManager.manualSave().then(function(){
                                    if (window.REPORT_ID) go(window.REPORT_ID);
                                }).catch(function(){});
                            }
                        } else { go(rid); }
                    }
                });
            });
        })();
    </script>
{% endblock %}
