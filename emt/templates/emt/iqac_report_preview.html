{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<style>
  /* PDF-like full preview: black background + centered white paper */
  body.command-center-layout.review-mode.preview-mode {
    background:#111827 !important; /* softer near-black (tailwind slate-900) */
    min-height:100vh;
    display:flex;
    justify-content:center;
    align-items:flex-start;
    padding:40px 0; /* top/bottom margin like a PDF viewer */
    overflow-y:auto;
  }
  /* White document container with shadow */
  .report-container{
    background:#fff;
    box-shadow:0 0 20px rgba(0,0,0,0.7);
    margin:auto;
  }

  /* Reviewer mode: hide editing/submit controls when body has .review-mode */
  .review-mode .controls,
  .review-mode .submit-report-actions,
  .review-mode .top-toolbar .toolbar,
  .review-mode [data-preview-continue],
  .review-mode #btn-back { display: none !important; }
  /* Also hide global site chrome when embedded in reviewer iframe */
  .review-mode .top-utility-bar,
  .review-mode .left-control-panel { display: none !important; }
  .review-mode .command-center-layout { padding: 0 !important; }
  /* Review full-screen feel: remove grey backgrounds/margins/shadows. Keep A4 width (no stretch) and center. */
  /* Default review-mode background is white; overridden to black when .preview-mode is present */
  body.command-center-layout.review-mode,
  body.command-center-layout.iqac-report-preview.review-mode { background:#fff !important; }
  body.command-center-layout.review-mode.preview-mode,
  body.command-center-layout.iqac-report-preview.review-mode.preview-mode { background:#111827 !important; }
  .review-mode .preview-shell {
    padding: 12px 0 !important;
    align-items: center !important;
    gap: 12px !important;
  }
  .review-mode main#report,
  .review-mode .paper {
    width: 210mm !important;
    min-height: auto !important;
    box-shadow: none !important;
    margin: 0 auto !important;
    border-radius: 0 !important;
    padding: 20mm 18mm 22mm !important; /* retain print padding */
    border: 1px solid #c8d3e1; /* subtle page border in review mode */
  }
  .review-mode .annexure-host {
    width: 210mm !important;
    margin: 0 auto !important;
    padding: 0 0 12mm !important;
  }
  .review-mode .annexure-host .paper {
    width: 210mm !important;
  }
  /* Embed-fit: scale pages to fit iframe viewport (right review pane) */
  .embed-fit .preview-shell {
    padding: 0 !important;
    gap: 0 !important;
    width: 210mm; /* base width for scaling */
    transform-origin: top center;
    transform: scale(var(--fit-scale, 1));
  }
  /* In iframe embed, use transparent background so iframe's own background shows */
  .embed-fit body.command-center-layout.review-mode { background: transparent !important; }
  body.embed-fit.command-center-layout.review-mode { background: transparent !important; }
  .embed-fit body.command-center-layout { overflow: hidden !important; height: 100vh !important; }
  body.embed-fit.command-center-layout { overflow: hidden !important; height: 100vh !important; }
  body.embed-fit.command-center-layout.fit-width { overflow: auto !important; }
  /* When explicitly fitting width, stop scaling and expand to 100% */
  body.embed-fit.fit-width .preview-shell {
    padding: 0 !important;
    gap: 0 !important;
    width: 100% !important;
    transform: none !important;
    align-items: stretch !important;
  }
  body.embed-fit.fit-width main#report,
  body.embed-fit.fit-width .paper,
  body.embed-fit.fit-width .annexure-host { width: 100% !important; margin: 0 !important; }
  body.embed-fit.fit-width .annexure-host .paper { width: 100% !important; }
  /* Soften inner borders while keeping the content boxes visible */
  .review-mode .section-table,
  .review-mode .section-table th,
  .review-mode .section-table td,
  .review-mode .grid-table,
  .review-mode .grid-table th,
  .review-mode .grid-table td,
  .review-mode .checklist,
  .review-mode .checklist th,
  .review-mode .checklist td,
  .review-mode .pane,
  .review-mode .sdg-row,
  .review-mode .analysis-card,
  .review-mode .annexure-card,
  .review-mode .media-frame,
  .review-mode .signature-line {
    border-color: #c8d3e1 !important; /* light gray-blue */
    border-width: 0.5pt !important;
  }
  @page {
    size: A4 portrait;
    margin: 25mm;
  }

  body.command-center-layout {
    background: #e6e6e6;
    font-family: "Times New Roman", "Georgia", serif;
    font-size: 11pt;
    line-height: 1.55;
    color: #111;
  }

  body.command-center-layout.iqac-report-preview {
    background: #e6e6e6;
  }

  .preview-shell {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
    padding: 24px;
  }

  .control-row,
  .submit-report-actions {
    width: 210mm;
    display: flex;
    align-items: center;
    justify-content: flex-end;
  }

  .control-row {
    gap: 10px;
  }

  .status-pill {
    margin-right: auto;
    padding: 4px 12px;
    border: 0.9px solid #111;
    border-radius: 14px;
    font-size: 10.5pt;
    background: #f3f3f3;
    letter-spacing: 0.02em;
  }

  .controls {
    display: flex;
    gap: 8px;
  }

  .controls button,
  .controls .control-button {
    font-family: "Times New Roman", "Georgia", serif;
    font-size: 11pt;
    padding: 5px 18px;
    border: 0.9px solid #111;
    background: #fafafa;
    color: #111;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-height: 30px;
    text-decoration: none;
    letter-spacing: 0.01em;
    cursor: pointer;
  }

  .controls .control-button.primary {
    background: #2c5aa0;
    border-color: #2c5aa0;
    color: #fff;
  }

  .controls .control-button.primary:hover,
  .controls .control-button.primary:focus {
    background: #244a82;
    border-color: #244a82;
    color: #fff;
  }

  .controls .control-button[aria-disabled="true"] {
    background: #c5ccd8;
    border-color: #c5ccd8;
    color: #f5f5f5;
    cursor: not-allowed;
  }

  .controls button:focus,
  .controls .control-button:focus {
    outline: 1pt dotted #111;
    outline-offset: 2px;
  }

  .generate-ai-form {
    display: inline;
    margin: 0;
  }

  .submit-report-actions {
    margin: 12px 0 32px;
  }

  .submit-report-actions form {
    margin: 0;
  }

  .submit-report-actions .submit-report-button {
    font-family: "Times New Roman", "Georgia", serif;
    font-size: 11pt;
    padding: 6px 24px;
    border: 0.9px solid #2c5aa0;
    background: #2c5aa0;
    color: #fff;
    letter-spacing: 0.02em;
    cursor: pointer;
  }

  .submit-report-actions .submit-report-button:hover,
  .submit-report-actions .submit-report-button:focus {
    background: #244a82;
    border-color: #244a82;
    color: #fff;
  }

  .paper {
    width: 210mm;
    background: #fff;
    padding: 25mm;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.16);
    color: #111;
  }

  p {
    margin: 0 0 6pt;
  }

  .report-title-block {
    text-align: center;
  }

  .report-title-block .line {
    margin: 0;
  }

  .report-title-block .university {
    font-size: 13.8pt;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .report-title-block .campus {
    font-size: 10.3pt;
    font-style: italic;
    letter-spacing: 0.02em;
    margin-top: 2pt;
  }

  .report-title-block .cell-name,
  .report-title-block .report-name,
  .report-title-block .event-title {
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .report-title-block .cell-name,
  .report-title-block .report-name {
    font-size: 12pt;
  }

  .report-title-block .event-title {
    font-size: 12pt;
    margin-top: 4pt;
  }

  .title-rule {
    border: none;
    border-top: 0.9px solid #111;
    margin: 14pt 0;
  }

  .report-section {
    margin-top: 12pt;
  }

  .report-section:first-of-type {
    margin-top: 0;
  }

  .report-section h2 {
    font-size: 11pt;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    margin: 12pt 0 6pt;
  }

  .report-section:first-of-type h2 {
    margin-top: 0;
  }

  .grid-table {
    width: 100%;
    border-collapse: collapse;
    border: 0.9px solid #111;
    table-layout: fixed;
    background: #fff;
  }

  .grid-table col.col-label {
    width: 32%;
  }

  .grid-table col.col-value {
    width: 68%;
  }

  .grid-table th,
  .grid-table td {
    border: 0.9px solid #111;
    padding: 8px 10px;
    vertical-align: top;
    line-height: 1.4;
  }

  .grid-table th {
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.02em;
    background: #f6f6f6;
    word-break: break-word;
    hyphens: auto;
  }

  .grid-table td {
    text-align: left;
    word-break: break-word;
    hyphens: auto;
  }

  .grid-table td[data-placeholder="true"] {
    color: #555;
    text-align: center;
  }

  .grid-table td[data-multiline="true"] {
    text-align: justify;
  }

  .grid-table td[data-multiline="true"] p {
    margin: 0 0 6pt;
  }

  .stacked-lines {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .stacked-lines .subheading {
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.02em;
  }

  .stacked-lines .subline {
    display: flex;
    gap: 4px;
  }

  .paper-box,
  .box {
    border: 0.9px solid #111;
    padding: 10px 12px;
    background: #fff;
  }

  .paragraph-box {
    min-height: 120px;
  }

  .paragraph-box[data-placeholder="true"] {
    display: flex;
    align-items: center;
    justify-content: center;
    color: #555;
    text-align: center;
  }

  .paragraph-box p {
    margin: 0 0 6pt;
    text-align: justify;
  }

  .paragraph-box ul {
    margin: 0 0 6pt;
  }

  .bullets {
    list-style: disc;
    padding-left: 20px;
    margin: 0 0 8pt;
  }

  .bullets li {
    margin-bottom: 4pt;
    text-align: justify;
  }

  .bullets[data-empty="true"] {
    list-style: none;
    padding-left: 0;
  }

  .bullets[data-empty="true"] li {
    text-align: center;
    color: #555;
  }

  .analysis-box {
    padding: 12px 14px;
  }

  .analysis-box .bullets {
    margin-bottom: 0;
  }

  .analysis-box .bullets li strong {
    font-weight: 700;
  }

  .date-line {
    margin-top: 10pt;
    font-weight: 700;
  }

  .date-line span:first-child {
    text-transform: uppercase;
    letter-spacing: 0.02em;
  }

  .signatures {
    display: flex;
    gap: 28px;
    margin-top: 24pt;
  }

  .signatures .sig {
    flex: 1;
    text-align: center;
  }

  .signatures .line {
    border-bottom: 0.9px solid #111;
    height: 0;
    margin: 0 18px 8px;
  }

  .signatures .name {
    font-size: 11pt;
    min-height: 14pt;
  }

  .signatures .label {
    font-size: 10pt;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .report-footer {
    margin-top: 28pt;
  }

  .report-footer hr {
    border: none;
    border-top: 0.9px solid #111;
    margin: 0;
  }

  .report-footer p {
    font-size: 9.8pt;
    margin: 6pt 0 0;
    text-align: center;
    letter-spacing: 0.02em;
  }

  .page-break-before {
    page-break-before: always;
    break-before: page;
  }

  table,
  tr,
  td,
  th,
  ul,
  ol,
  li,
  p {
    page-break-inside: avoid;
  }

  .hidden {
    display: none !important;
  }

  .edit-input,
  .edit-textarea {
    width: 100%;
    box-sizing: border-box;
    font-family: "Times New Roman", "Georgia", serif;
    font-size: 11pt;
    line-height: 1.55;
    border: 0.9px solid #666;
    padding: 6px 8px;
  }

  .edit-textarea {
    min-height: 84px;
    resize: vertical;
  }

  @media print {
    body.command-center-layout {
      background: #fff;
    }

    .top-utility-bar,
    .left-control-panel,
    .control-row,
    .submit-report-actions {
      display: none !important;
    }

    .preview-shell {
      padding: 0;
    }

    .paper {
      box-shadow: none;
      margin: 0;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="preview-shell report-container">
  <div class="control-row">
    <span class="status-pill" id="status-pill">Preparing content…</span>
    <div class="controls">
      <form id="generate-ai-form" class="generate-ai-form" method="post" action="{% url 'emt:submit_event_report' proposal.id %}">
        {% csrf_token %}
        {% for key, values in post_data_items %}
          {% if key != 'csrfmiddlewaretoken' and key != 'generate_ai' %}
            {% for value in values %}
              <input type="hidden" name="{{ key }}" value="{{ value }}">
            {% endfor %}
          {% endif %}
        {% endfor %}
        <input type="hidden" name="generate_ai" value="1">
        <button type="submit" class="control-button primary" id="generate-ai-report"{% if not form_is_valid %} aria-disabled="true" data-disabled="true" title="Resolve required fields before generating the AI report."{% endif %}>Generate Report</button>
      </form>
      <button type="button" id="edit-toggle" data-mode="preview">Edit</button>
      <button type="button" id="print-btn">Print / Save PDF</button>
    </div>
  </div>

  <main id="iqac-report-page" class="paper">
    <header class="report-title-block">
      <p class="line university">CHRIST (DEEMED TO BE UNIVERSITY)</p>
      <p class="line campus">Pune Lavasa Campus – &lsquo;The Hub of Analytics&rsquo;</p>
      <p class="line cell-name">INTERNAL QUALITY ASSURANCE CELL (IQAC)</p>
      <p class="line event-title" data-field="event_info.event_title" data-hide-blank="true">—</p>
      <p class="line report-name">ACTIVITY REPORT</p>
    </header>

    <hr class="title-rule">

    <section class="report-section" id="event-information">
      <h2>EVENT INFORMATION</h2>
      <table class="grid-table full-width">
        <colgroup>
          <col class="col-label">
          <col class="col-value">
        </colgroup>
        <tbody>
          <tr>
            <th>Department</th>
            <td data-field="event_info.department">—</td>
          </tr>
          <tr>
            <th>Location</th>
            <td data-field="event_info.location">—</td>
          </tr>
          <tr>
            <th>Event Title</th>
            <td data-field="event_info.event_title">—</td>
          </tr>
          <tr>
            <th>No of Activities</th>
            <td data-field="event_info.activities_count">—</td>
          </tr>
          <tr>
            <th>Date and Time</th>
            <td data-field="event_info.datetime">—</td>
          </tr>
          <tr>
            <th>Venue</th>
            <td data-field="event_info.venue">—</td>
          </tr>
          <tr>
            <th>Academic Year</th>
            <td data-field="event_info.academic_year">—</td>
          </tr>
          <tr>
            <th>Event Type (Focus)</th>
            <td data-field="event_info.focus">—</td>
          </tr>
        </tbody>
      </table>
    </section>

    <section class="report-section" id="participants-information">
      <h2>PARTICIPANTS INFORMATION</h2>
      <table class="grid-table full-width">
        <colgroup>
          <col class="col-label">
          <col class="col-value">
        </colgroup>
        <tbody>
          <tr>
            <th>Target Audience</th>
            <td data-field="participants.target_audience">—</td>
          </tr>
          <tr>
            <th>Details of any External Agencies, Speakers, Guests with Affiliation</th>
            <td data-field="participants.external_agencies">—</td>
          </tr>
          <tr>
            <th>Website / Contact of External Members</th>
            <td data-field="participants.external_contacts">—</td>
          </tr>
          <tr>
            <th>Organising Committee Details</th>
            <td>
              <div class="stacked-lines">
                <div class="subheading">Event Coordinators:</div>
                <ul class="bullets" data-list="participants.organising_committee" data-empty="true">
                  <li>—</li>
                </ul>
                <div class="subline">
                  <span class="subheading">No of Student Volunteers:</span>
                  <span data-field="participants.student_volunteers">—</span>
                </div>
              </div>
            </td>
          </tr>
          <tr>
            <th>No of Attendees / Participants</th>
            <td data-field="participants.participants_count">—</td>
          </tr>
        </tbody>
      </table>
    </section>

    <section class="report-section page-break-before" id="summary">
      <h2>SUMMARY OF THE OVERALL EVENT</h2>
      <div class="paper-box paragraph-box" data-field="summary" data-multiline="true" data-edit="textarea">—</div>
    </section>

    <section class="report-section page-break-before" id="outcomes">
      <h2>OUTCOMES OF THE EVENT</h2>
      <ul class="bullets" data-list="outcomes" data-empty="true">
        <li>—</li>
      </ul>
    </section>

    <section class="report-section" id="analysis">
      <h2>ANALYSIS</h2>
      <div class="box analysis-box">
        <ul class="bullets" id="analysis-list">
          <li><strong>Impact on the Attendees:</strong> —</li>
          <li><strong>Impact on Schools:</strong> —</li>
          <li><strong>Impact on Volunteers:</strong> —</li>
        </ul>
      </div>
    </section>

    <section class="report-section page-break-before" id="relevance">
      <h2>RELEVANCE OF THE EVENT</h2>
      <table class="grid-table full-width">
        <colgroup>
          <col class="col-label">
          <col class="col-value">
        </colgroup>
        <tbody>
          <tr>
            <th>With reference to Graduate Attributes</th>
            <td data-field="relevance.graduate_attributes" data-multiline="true">—</td>
          </tr>
          <tr>
            <th>Support to Value Systems (Cross Cutting Issues such as Gender, Environmental aspects, SDGs, Social Commitment, etc)</th>
            <td data-field="relevance.sdg" data-multiline="true">—</td>
          </tr>
          <tr class="sdg-row">
            <th>Aligned SDG Goals</th>
            <td>
              <ul class="bullets" data-list="mapping.sdg_goal_numbers" data-empty="true">
                <li>—</li>
              </ul>
            </td>
          </tr>
        </tbody>
      </table>
    </section>

    <section class="report-section" id="suggestions">
      <h2>SUGGESTIONS FOR IMPROVEMENT / FEEDBACK FROM IQAC</h2>
      <div class="box">
        <ul class="bullets" data-list="suggestions" data-empty="true">
          <li>—</li>
        </ul>
      </div>
      <div class="date-line"><span>Date:&nbsp;</span><span data-field="suggestions_date">—</span></div>

      <div class="signatures">
        <div class="sig">
          <div class="line"></div>
          <div class="name" data-field="signatures.head">—</div>
          <div class="label">HEAD / COORDINATOR</div>
        </div>
        <div class="sig">
          <div class="line"></div>
          <div class="name" data-field="signatures.faculty">—</div>
          <div class="label">FACULTY COORDINATOR / ORGANISER</div>
        </div>
        <div class="sig">
          <div class="line"></div>
          <div class="name" data-field="signatures.iqac">—</div>
          <div class="label">IQAC</div>
        </div>
      </div>
    </section>

    <footer class="report-footer">
      <hr>
      <p>CHRIST (Deemed to be University), Pune Lavasa Campus – &ldquo;The Hub of Analytics&rdquo;</p>
    </footer>
  </main>

  <div class="submit-report-actions">
    <form method="post" action="{% url 'emt:ai_report_submit' proposal.id %}">
      {% csrf_token %}
      <button type="submit" class="submit-report-button">Submit Report</button>
    </form>
  </div>
</div>

<script type="application/json" id="initial-report-data">{{ initial_report_data|default:"{}"|safe }}</script>
<script>
  (function () {
    const state = {
      data: {},
      mode: 'preview'
    };

    const editState = {
      fields: [],
      lists: []
    };

    function isBlank(value) {
      if (value === null || value === undefined) return true;
      if (Array.isArray(value)) return value.every(isBlank);
      const str = String(value).trim();
      return str.length === 0;
    }

    function toArray(value) {
      if (value === null || value === undefined) return [];
      if (Array.isArray(value)) {
        return value
          .map(item => (typeof item === 'string' ? item.trim() : item))
          .filter(item => !isBlank(item));
      }
      if (typeof value === 'string') {
        return value
          .split(/[\n;,]+/)
          .map(item => item.trim())
          .filter(item => item);
      }
      return [];
    }

    function getValue(obj, path) {
      if (!obj || !path) return undefined;
      return path.split('.').reduce((acc, key) => {
        if (acc === null || acc === undefined) return undefined;
        return acc[key];
      }, obj);
    }

    function setValue(obj, path, value) {
      if (!path) return;
      const parts = path.split('.');
      let ref = obj;
      parts.forEach((part, index) => {
        if (index === parts.length - 1) {
          ref[part] = value;
        } else {
          if (typeof ref[part] !== 'object' || ref[part] === null) {
            ref[part] = {};
          }
          ref = ref[part];
        }
      });
    }

    function resolveNodes(selectorOrNodes) {
      if (!selectorOrNodes) return [];
      if (typeof selectorOrNodes === 'string') {
        return Array.from(document.querySelectorAll(selectorOrNodes));
      }
      if (selectorOrNodes instanceof Node) {
        return [selectorOrNodes];
      }
      if (selectorOrNodes instanceof NodeList || Array.isArray(selectorOrNodes)) {
        return Array.from(selectorOrNodes);
      }
      return [];
    }

    function displayValue(value) {
      return isBlank(value) ? '—' : String(value).trim();
    }

    function renderMultiline(node, rawValue) {
      const text = Array.isArray(rawValue)
        ? rawValue.map(item => String(item ?? '')).join('\n')
        : String(rawValue ?? '');
      const lines = text.replace(/\r/g, '').split('\n');
      let listEl = null;
      let appended = false;
      lines.forEach(line => {
        const trimmed = line.trim();
        if (!trimmed) {
          listEl = null;
          return;
        }
        const bulletMatch = trimmed.match(/^[•·\-–]\s*(.+)$/);
        if (bulletMatch) {
          if (!listEl) {
            listEl = document.createElement('ul');
            listEl.className = 'bullets';
            node.appendChild(listEl);
          }
          const li = document.createElement('li');
          li.textContent = bulletMatch[1];
          listEl.appendChild(li);
        } else {
          listEl = null;
          const p = document.createElement('p');
          p.textContent = trimmed;
          node.appendChild(p);
        }
        appended = true;
      });
      return appended;
    }

    function setText(selector, value) {
      const nodes = resolveNodes(selector);
      nodes.forEach(node => {
        if (!node) return;
        const hideBlank = node.dataset && node.dataset.hideBlank === 'true';
        const isMultiline = node.dataset && node.dataset.multiline === 'true';
        const hasValue = !isBlank(value);
        if (isMultiline) {
          node.innerHTML = '';
          const appended = hasValue ? renderMultiline(node, value) : false;
          if (!appended) {
            node.textContent = '—';
            node.setAttribute('data-placeholder', 'true');
          } else {
            node.setAttribute('data-placeholder', 'false');
          }
          if (hideBlank) {
            node.style.display = appended ? '' : 'none';
          }
        } else {
          const content = displayValue(value);
          node.textContent = content;
          node.setAttribute('data-placeholder', content === '—' ? 'true' : 'false');
          if (hideBlank) {
            node.style.display = content === '—' ? 'none' : '';
          }
        }
      });
    }

    function setList(selector, arr) {
      const nodes = resolveNodes(selector);
      nodes.forEach(node => {
        if (!node) return;
        const values = toArray(arr);
        if (node.tagName === 'UL' || node.tagName === 'OL') {
          node.innerHTML = '';
          if (!values.length) {
            const li = document.createElement('li');
            li.textContent = '—';
            node.appendChild(li);
            node.setAttribute('data-empty', 'true');
          } else {
            values.forEach(item => {
              const li = document.createElement('li');
              li.textContent = String(item);
              node.appendChild(li);
            });
            node.setAttribute('data-empty', 'false');
          }
        } else {
          node.textContent = values.length ? values.join(', ') : '—';
        }
      });
    }

    function normalizeData(raw) {
      const source = raw && typeof raw === 'object' ? raw : {};
      const eventSource = source.event_info || source.event || {};
      const participantsSource = source.participants || source.participants_info || {};
      const committeeSource = participantsSource.organising_committee || {};
      const committeeData = (!Array.isArray(committeeSource) && typeof committeeSource === 'object') ? committeeSource : {};
      const narrativeSource = source.narrative || {};
      const analysisSource = source.analysis || {};
      const mappingSource = source.mapping || {};
      const relevanceSource = source.relevance || {};
      const iqacSource = source.iqac || {};
      const suggestionsSource = source.suggestions || {};

      let committeeEntries = committeeData.event_coordinators ?? participantsSource.event_coordinators ?? [];
      if (Array.isArray(committeeSource)) {
        committeeEntries = committeeSource;
      }

      return {
        event_info: {
          department: eventSource.department ?? '',
          location: eventSource.location ?? '',
          event_title: eventSource.event_title ?? eventSource.title ?? '',
          activities_count: eventSource.activities_count ?? eventSource.no_of_activities ?? '',
          datetime: eventSource.datetime ?? eventSource.date_time ?? eventSource.date ?? '',
          venue: eventSource.venue ?? '',
          academic_year: eventSource.academic_year ?? '',
          focus: eventSource.focus ?? eventSource.event_type_focus ?? '',
        },
        participants: {
          target_audience: participantsSource.target_audience ?? '',
          external_agencies: participantsSource.external_agencies ?? participantsSource.external_agencies_speakers ?? '',
          external_contacts: participantsSource.external_contacts ?? '',
          organising_committee: toArray(committeeEntries),
          student_volunteers: participantsSource.student_volunteers ?? committeeData.student_volunteers_count ?? participantsSource.student_volunteers_count ?? '',
          participants_count: participantsSource.participants_count ?? participantsSource.attendees_count ?? '',
        },
        summary: source.summary ?? narrativeSource.summary ?? narrativeSource.summary_overall_event ?? '',
        outcomes: toArray(source.outcomes ?? narrativeSource.outcomes),
        analysis: {
          attendees: analysisSource.attendees ?? analysisSource.impact_attendees ?? '',
          schools: analysisSource.schools ?? analysisSource.impact_schools ?? '',
          volunteers: analysisSource.volunteers ?? analysisSource.impact_volunteers ?? '',
        },
        relevance: {
          graduate_attributes: relevanceSource.graduate_attributes ?? mappingSource.graduate_attributes_or_needs ?? mappingSource.pos_psos ?? '',
          sdg: relevanceSource.sdg ?? relevanceSource.value_systems ?? mappingSource.value_systems ?? '',
        },
        mapping: {
          sdg_goal_numbers: toArray(mappingSource.sdg_goal_numbers ?? mappingSource.sdg_goals),
        },
        suggestions: toArray(source.suggestions ?? iqacSource.iqac_suggestions ?? suggestionsSource.list),
        suggestions_date: source.suggestions_date ?? iqacSource.iqac_review_date ?? '',
        signatures: {
          head: source.signatures?.head ?? iqacSource.sign_head_coordinator ?? '',
          faculty: source.signatures?.faculty ?? iqacSource.sign_faculty_coordinator ?? '',
          iqac: source.signatures?.iqac ?? iqacSource.sign_iqac ?? '',
        },
      };
    }

    function renderAnalysis(data) {
      const root = document.getElementById('iqac-report-page');
      if (!root) return;
      const list = root.querySelector('#analysis-list');
      if (!list) return;
      const items = [
        { label: 'Impact on the Attendees', key: 'attendees' },
        { label: 'Impact on Schools', key: 'schools' },
        { label: 'Impact on Volunteers', key: 'volunteers' },
      ];
      list.innerHTML = '';
      items.forEach(({ label, key }) => {
        const li = document.createElement('li');
        const strong = document.createElement('strong');
        strong.textContent = label + ': ';
        li.appendChild(strong);
        const span = document.createElement('span');
        span.setAttribute('data-field', `analysis.${key}`);
        span.dataset.edit = 'textarea';
        span.textContent = displayValue(getValue(data, `analysis.${key}`));
        li.appendChild(span);
        list.appendChild(li);
      });
    }

    function populateReport(data) {
      const fieldMap = [
        { selector: '[data-field="event_info.event_title"]', path: 'event_info.event_title' },
        { selector: '[data-field="event_info.department"]', path: 'event_info.department' },
        { selector: '[data-field="event_info.location"]', path: 'event_info.location' },
        { selector: '[data-field="event_info.activities_count"]', path: 'event_info.activities_count' },
        { selector: '[data-field="event_info.datetime"]', path: 'event_info.datetime' },
        { selector: '[data-field="event_info.venue"]', path: 'event_info.venue' },
        { selector: '[data-field="event_info.academic_year"]', path: 'event_info.academic_year' },
        { selector: '[data-field="event_info.focus"]', path: 'event_info.focus' },
        { selector: '[data-field="participants.target_audience"]', path: 'participants.target_audience' },
        { selector: '[data-field="participants.external_agencies"]', path: 'participants.external_agencies' },
        { selector: '[data-field="participants.external_contacts"]', path: 'participants.external_contacts' },
        { selector: '[data-field="participants.student_volunteers"]', path: 'participants.student_volunteers' },
        { selector: '[data-field="participants.participants_count"]', path: 'participants.participants_count' },
        { selector: '[data-field="summary"]', path: 'summary' },
        { selector: '[data-field="relevance.graduate_attributes"]', path: 'relevance.graduate_attributes' },
        { selector: '[data-field="relevance.sdg"]', path: 'relevance.sdg' },
        { selector: '[data-field="suggestions_date"]', path: 'suggestions_date' },
        { selector: '[data-field="signatures.head"]', path: 'signatures.head' },
        { selector: '[data-field="signatures.faculty"]', path: 'signatures.faculty' },
        { selector: '[data-field="signatures.iqac"]', path: 'signatures.iqac' }
      ];

      fieldMap.forEach(item => setText(item.selector, getValue(data, item.path)));

      setList('[data-list="participants.organising_committee"]', getValue(data, 'participants.organising_committee'));
      setList('[data-list="mapping.sdg_goal_numbers"]', getValue(data, 'mapping.sdg_goal_numbers'));
      setList('[data-list="outcomes"]', getValue(data, 'outcomes'));
      setList('[data-list="suggestions"]', getValue(data, 'suggestions'));

      renderAnalysis(data);
    }

    function renderReport() {
      populateReport(state.data);
      const status = document.getElementById('status-pill');
      if (status) status.classList.add('hidden');
    }

    function enterEdit() {
      if (state.mode === 'edit') return;
      editState.fields = [];
      editState.lists = [];
      document.querySelectorAll('[data-field]').forEach(node => {
        const path = node.getAttribute('data-field');
        if (!path || node.dataset.editing === 'true') return;
        if (node.dataset && node.dataset.hideBlank === 'true') {
          node.style.display = '';
        }
        const multiline = node.dataset.edit === 'textarea' || node.dataset.multiline === 'true';
        const input = multiline ? document.createElement('textarea') : document.createElement('input');
        input.className = multiline ? 'edit-textarea' : 'edit-input';
        if (!multiline) input.type = 'text';
        const currentValue = getValue(state.data, path);
        if (!isBlank(currentValue)) {
          input.value = Array.isArray(currentValue) ? currentValue.join(', ') : String(currentValue);
        } else {
          input.value = '';
        }
        node.dataset.editing = 'true';
        node.innerHTML = '';
        node.appendChild(input);
        editState.fields.push({ node, path, input, multiline });
      });
      document.querySelectorAll('[data-list]').forEach(node => {
        const path = node.getAttribute('data-list');
        if (!path || node.dataset.editing === 'true') return;
        const textarea = document.createElement('textarea');
        textarea.className = 'edit-textarea';
        textarea.value = toArray(getValue(state.data, path)).join('\n');
        node.dataset.editing = 'true';
        node.innerHTML = '';
        node.appendChild(textarea);
        editState.lists.push({ node, path, textarea });
      });
      state.mode = 'edit';
    }

    function exitEdit() {
      editState.fields.forEach(entry => {
        const rawValue = entry.input.value || '';
        const value = entry.multiline
          ? rawValue.replace(/\r/g, '\n').trim()
          : rawValue.trim();
        setValue(state.data, entry.path, value);
        entry.node.removeAttribute('data-editing');
        entry.node.innerHTML = '';
      });
      editState.lists.forEach(entry => {
        const raw = entry.textarea.value.replace(/\r/g, '\n');
        const items = toArray(raw);
        setValue(state.data, entry.path, items);
        entry.node.removeAttribute('data-editing');
        entry.node.innerHTML = '';
      });
      editState.fields = [];
      editState.lists = [];
      state.mode = 'preview';
      renderReport();
    }

    function attachEvents() {
      const toggle = document.getElementById('edit-toggle');
      const printBtn = document.getElementById('print-btn');
      if (toggle) {
        toggle.addEventListener('click', function () {
          if (state.mode === 'preview') {
            enterEdit();
            toggle.textContent = 'Preview';
          } else {
            exitEdit();
            toggle.textContent = 'Edit';
          }
        });
      }
      if (printBtn) {
        printBtn.addEventListener('click', function () {
          if (state.mode === 'edit') {
            exitEdit();
            const toggleBtn = document.getElementById('edit-toggle');
            if (toggleBtn) toggleBtn.textContent = 'Edit';
          }
          window.print();
        });
      }
    }

    function init() {
      const raw = document.getElementById('initial-report-data');
      let data = {};
      if (raw && raw.textContent.trim()) {
        try {
          data = JSON.parse(raw.textContent);
        } catch (err) {
          console.warn('Unable to parse initial report data', err);
        }
      }
      state.data = normalizeData(data);
      renderReport();
      attachEvents();
    }

    document.addEventListener('DOMContentLoaded', function () {
      document.body.classList.add('iqac-report-preview');
      var flag = document.getElementById('review-mode-flag');
      if (flag && flag.getAttribute('data-review-mode') === 'true') {
        document.body.classList.add('review-mode');
      }
      // Auto-enable PDF-like preview mode on full preview pages, but skip when embedded (?embed=1)
      var params = new URLSearchParams(window.location.search);
      if (!params.has('embed')) {
        document.body.classList.add('preview-mode');
      }
      init();

      const generateBtn = document.getElementById('generate-ai-report');
      if (generateBtn && generateBtn.dataset.disabled === 'true') {
        generateBtn.setAttribute('tabindex', '-1');
        generateBtn.addEventListener('click', function (event) {
          event.preventDefault();
          window.alert('Please complete the required sections in the event report before generating the AI report.');
        });
        if (generateBtn.form) {
          generateBtn.form.addEventListener('submit', function (event) {
            event.preventDefault();
          });
        }
      }
    });

    // Scale-to-fit logic for embedded iframe view (?embed=1)
    function mmToPx(mm){ return Math.round(mm * 96 / 25.4); }
    function applyFitScale(){
      const params = new URLSearchParams(window.location.search);
      if (!params.has('embed')) return;
      document.body.classList.add('embed-fit');
      const fit = params.get('fit');
      if (fit === 'width') {
        document.body.classList.add('fit-width');
      } else if (fit === 'height') {
        document.body.classList.add('fit-height');
      }
      // Compute scale based on requested fit mode
      const pageW = mmToPx(210);
      const pageH = mmToPx(297);
      const vw = window.innerWidth;
      const vh = window.innerHeight;
      let scale;
      if (fit === 'width') {
        scale = vw / pageW;
      } else if (fit === 'height') {
        scale = vh / pageH;
      } else {
        scale = Math.min(vw / pageW, vh / pageH);
      }
      document.documentElement.style.setProperty('--fit-scale', scale);
    }
    window.addEventListener('resize', applyFitScale);
    applyFitScale();
  })();
</script>
<div id="review-mode-flag" data-review-mode="{{ review_mode|yesno:'true,false' }}" hidden></div>
{% endblock %}
