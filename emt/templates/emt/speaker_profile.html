{% extends "base.html" %}
{% load static %}

{% block title %}Speaker Profiles{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="{% static 'emt/css/styles.css' %}">
{% endblock %}

{% block content %}
<div class="container">
  <div class="header">
    <h1>Speaker Profiles for "{{ proposal.event_title }}"</h1>
    <p>Provide details for each invited speaker or guest.</p>
  </div>

  <div class="page-content">
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      {{ formset.management_form }}
      {% if formset.non_form_errors %}
        <div class="form-errors">
          <ul>
            {% for error in formset.non_form_errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
      <div class="section">
        <h3>Speaker Profiles</h3>
        {% for form in formset %}
          <div class="section speaker-form">
            <h4>Speaker {{ forloop.counter }}</h4>
            {% if form.non_field_errors %}
              <div class="form-errors">
                <ul>
                  {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
            <div class="input-group">{{ form.full_name.label_tag }} {{ form.full_name.as_widget(attrs={'class': 'proposal-input'}) }}</div>
            {% if form.full_name.errors %}
              <div class="field-errors">
                {% for error in form.full_name.errors %}<div>{{ error }}</div>{% endfor %}
              </div>
            {% endif %}
            <div class="input-group">{{ form.designation.label_tag }} {{ form.designation.as_widget(attrs={'class': 'proposal-input'}) }}</div>
            {% if form.designation.errors %}
              <div class="field-errors">
                {% for error in form.designation.errors %}<div>{{ error }}</div>{% endfor %}
              </div>
            {% endif %}
            <div class="input-group">{{ form.affiliation.label_tag }} {{ form.affiliation.as_widget(attrs={'class': 'proposal-input'}) }}</div>
            {% if form.affiliation.errors %}
              <div class="field-errors">
                {% for error in form.affiliation.errors %}<div>{{ error }}</div>{% endfor %}
              </div>
            {% endif %}
            <div class="input-group">{{ form.contact_email.label_tag }} {{ form.contact_email.as_widget(attrs={'class': 'proposal-input'}) }}</div>
            {% if form.contact_email.errors %}
              <div class="field-errors">
                {% for error in form.contact_email.errors %}<div>{{ error }}</div>{% endfor %}
              </div>
            {% endif %}
            <div class="input-group">{{ form.contact_number.label_tag }} {{ form.contact_number.as_widget(attrs={'class': 'proposal-input'}) }}</div>
            {% if form.contact_number.errors %}
              <div class="field-errors">
                {% for error in form.contact_number.errors %}<div>{{ error }}</div>{% endfor %}
              </div>
            {% endif %}
            <div class="input-group">{{ form.linkedin_url.label_tag }} {{ form.linkedin_url.as_widget(attrs={'class': 'proposal-input'}) }}</div>
            {% if form.linkedin_url.errors %}
              <div class="field-errors">
                {% for error in form.linkedin_url.errors %}<div>{{ error }}</div>{% endfor %}
              </div>
            {% endif %}
            <div class="input-group">{{ form.photo.label_tag }} {{ form.photo.as_widget(attrs={'class': 'proposal-input'}) }}<img class="linkedin-photo" style="max-width:100px; display:none;"/></div>
            {% if form.photo.errors %}
              <div class="field-errors">
                {% for error in form.photo.errors %}<div>{{ error }}</div>{% endfor %}
              </div>
            {% endif %}
            <div class="input-group">{{ form.detailed_profile.label_tag }} {{ form.detailed_profile.as_widget(attrs={'class': 'proposal-input'}) }}</div>
            {% if form.detailed_profile.errors %}
              <div class="field-errors">
                {% for error in form.detailed_profile.errors %}<div>{{ error }}</div>{% endfor %}
              </div>
            {% endif %}
            {% if form.DELETE %}
              <div class="input-group">{{ form.DELETE.as_widget(attrs={'class': 'proposal-input'}) }} Remove this speaker</div>
            {% endif %}
          </div>
          <hr>
        {% endfor %}
      </div>
      <div class="input-group">
        <button type="submit" class="btn">Save &amp; Continue</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <script>
    window.PROPOSAL_ID = "{{ proposal.id|default:'' }}";
    window.AUTOSAVE_URL = "{% url 'emt:autosave_proposal' %}";
    window.AUTOSAVE_CSRF = "{{ csrf_token }}";
  </script>
  <script src="{% static 'emt/js/autosave_draft.js' %}"></script>
  <script>
    document.querySelectorAll('.speaker-form').forEach(function(form){
      const urlInput = form.querySelector("input[name$='linkedin_url']");
      if(!urlInput) return;
      urlInput.addEventListener('change', async function(){
        const url = urlInput.value.trim();
        if(!url) return;
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        try {
          const resp = await fetch("{% url 'emt:fetch_linkedin_profile' %}", {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({url})
          });
          if(!resp.ok) return;
          const data = await resp.json();
          const nameInput = form.querySelector("input[name$='full_name']");
          const desigInput = form.querySelector("input[name$='designation']");
          const affInput = form.querySelector("input[name$='affiliation']");
          const photoInput = form.querySelector("input[name$='photo']");
          const imgPreview = form.querySelector('.linkedin-photo');
          if(data.name && nameInput && !nameInput.value) nameInput.value = data.name;
          if(data.designation && desigInput && !desigInput.value) desigInput.value = data.designation;
          if(data.affiliation && affInput && !affInput.value) affInput.value = data.affiliation;
          if(data.image && imgPreview){
            imgPreview.src = data.image;
            imgPreview.style.display = 'block';
            if(photoInput){
              try {
                const imgResp = await fetch(data.image);
                const blob = await imgResp.blob();
                const file = new File([blob], 'photo.jpg', {type: blob.type});
                const dt = new DataTransfer();
                dt.items.add(file);
                photoInput.files = dt.files;
              } catch(err){
                console.error('Could not set photo file', err);
              }
            }
          }
        } catch(e){
          console.error('LinkedIn fetch failed', e);
        }
      });
    });
  </script>
{% endblock %}
