{% extends "base.html" %}
{% load static %}

{% block title %}Submit Event Proposal{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="{% static 'emt/css/styles.css' %}">
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/corejs-typeahead/1.3.1/typeaheadjs.min.css" rel="stylesheet" />
  <style>
    .typeahead, .tt-query, .tt-hint {
      width: 100%;
      height: 38px;
      padding: 6px 12px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      background: #fff;
      font-size: 16px;
    }
    .tt-menu {
      width: 100%;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .tt-suggestion {
      padding: 8px 14px;
      cursor: pointer;
    }
    .tt-suggestion:hover, .tt-suggestion.tt-cursor {
      background: #0d6efd;
      color: #fff;
    }
    .input-group {
      margin-bottom: 18px;
    }
    .input-group label {
      font-weight: 500;
    }
    .has-error input, .has-error .typeahead {
      border-color: #d9534f;
    }
    .error {
      color: #d9534f;
      font-size: 90%;
    }
  </style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="header">
    <h1>Submit Your Event Proposal</h1>
    <p>Fill out the details below to register your event.</p>
  </div>
  {% if form.errors %}
    <div style="color: red;">
      <strong>Form Errors:</strong>
      <pre>{{ form.errors }}</pre>
    </div>
  {% endif %}
  <div class="page-content">
    <form method="post" enctype="multipart/form-data" class="proposal-form" autocomplete="off">
      {% csrf_token %}
      <div class="section">
        <div class="input-group">
          {{ form.organization_type.label_tag }} {{ form.organization_type }}
        </div>
        <div class="input-group">
          {{ form.organization.label_tag }} {{ form.organization }}
          {% for err in form.organization.errors %}<span class="error">{{ err }}</span>{% endfor %}
        </div>

        <!-- Faculty incharges (AJAX select) -->
        <div class="input-group{% if form.faculty_incharges.errors %} has-error{% endif %}">
          <label for="faculty-select">{{ form.faculty_incharges.label }}</label>
          <select id="faculty-select" name="faculty_incharges" multiple>
            {% for user in form.fields.faculty_incharges.queryset %}
              {% if user.id|stringformat:"s" in form.faculty_incharges.value %}
                <option value="{{ user.id }}" selected>
                  {{ user.get_full_name|default:user.username }} ({{ user.email }})
                </option>
              {% endif %}
            {% endfor %}
          </select>
          {% for err in form.faculty_incharges.errors %}
            <span class="error">{{ err }}</span>
          {% endfor %}
        </div>

        <!-- All other fields (exclude org and faculty fields to prevent duplicates) -->
        {% for field in form.visible_fields %}
          {% if field.name not in "organization_type,organization,faculty_incharges" %}
            <div class="input-group{% if field.errors %} has-error{% endif %}">
              {{ field.label_tag }} {{ field }}
              {% if field.help_text %}
                <small class="help-text">{{ field.help_text }}</small>
              {% endif %}
              {% for e in field.errors %}
                <span class="error">{{ e }}</span>
              {% endfor %}
            </div>
          {% endif %}
        {% endfor %}
      </div>

      <button type="submit" name="submit" class="btn btn-primary" style="margin-top:24px;">
        Save &amp; Continue
      </button>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const typeSelect = document.getElementById('id_organization_type');
      const orgSelect = document.getElementById('id_organization');

      async function loadOrgs() {
        const typeName = typeSelect.options[typeSelect.selectedIndex]?.text;
        if (!typeName) return;
        const resp = await fetch('{% url "emt:api_organizations" %}?org_type=' + encodeURIComponent(typeName));
        const data = await resp.json();
        orgSelect.innerHTML = '<option value="">---------</option>';
        data.forEach(item => {
          const opt = document.createElement('option');
          opt.value = item.id;
          opt.textContent = item.text;
          orgSelect.appendChild(opt);
        });
      }

      typeSelect.addEventListener('change', loadOrgs);
    });
  </script>
{% endblock %}
