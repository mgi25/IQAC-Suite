{% extends "base.html" %}
{% load static %}

{% block title %}Event Proposal Dashboard{% endblock %}

{% block head_extra %}
    <link rel="stylesheet" href="{% static 'emt/css/styles.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet"/>
{% endblock %}

{% block content %}
<div class="proposal-layout">
    <nav class="proposal-nav">
        <div class="nav-header">
            <h2 class="nav-title">Event Proposal</h2>
            <p class="nav-subtitle">Complete all sections to submit</p>
        </div>
        <ul class="nav-items">
            <li class="nav-item">
                <a href="#" class="nav-link active" data-section="basic-info" data-order="1">
                    <span class="nav-number">1</span>
                    <div class="nav-content">
                        <div class="nav-item-title">Basic Info</div>
                        <div class="nav-item-subtitle">Title, dates, type, location, etc.</div>
                    </div>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link disabled" data-section="why-this-event" data-order="2">
                    <span class="nav-number">2</span>
                    <div class="nav-content">
                        <div class="nav-item-title">Why This Event?</div>
                        <div class="nav-item-subtitle">Objective, GA Relevance, Learning Outcomes</div>
                    </div>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link disabled" data-section="schedule" data-order="3">
                    <span class="nav-number">3</span>
                    <div class="nav-content">
                        <div class="nav-item-title">Schedule</div>
                        <div class="nav-item-subtitle">Event timeline, sessions, flow</div>
                    </div>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link disabled" data-section="speakers" data-order="4">
                    <span class="nav-number">4</span>
                    <div class="nav-content">
                        <div class="nav-item-title">Speakers</div>
                        <div class="nav-item-subtitle">Names, expertise, brief bio, etc.</div>
                    </div>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link disabled" data-section="expenses" data-order="5">
                    <span class="nav-number">5</span>
                    <div class="nav-content">
                        <div class="nav-item-title">Expenses</div>
                        <div class="nav-item-subtitle">Budget, funding source, justification</div>
                    </div>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link disabled" data-section="income" data-order="6">
                    <span class="nav-number">6</span>
                    <div class="nav-content">
                        <div class="nav-item-title">Details of Income</div>
                        <div class="nav-item-subtitle">Registration fees, sponsorship, participation rates</div>
                    </div>
                </a>
            </li>
            <li class="nav-item">
                <a href="#" class="nav-link disabled" data-section="cdl-support" data-order="7" data-url="{% if proposal.id %}{% url 'emt:submit_cdl_support' proposal.id %}{% endif %}">
                    <span class="nav-number">7</span>
                    <div class="nav-content">
                        <div class="nav-item-title">CDL Support</div>
                        <div class="nav-item-subtitle">Upload poster, certificates, and related files.</div>
                    </div>
                </a>
            </li>
        </ul>
    </nav>

    <main class="proposal-content">
        <div class="content-header">
            <h1 class="content-title" id="main-title">Basic Information</h1>
            <p class="content-subtitle" id="main-subtitle">Organization details and event basics</p>
            <div class="content-actions">
                <button type="button" id="autofill-btn" class="btn-draft">Auto-Fill Test Data</button>
                <button type="button" id="reset-draft-btn" class="btn-draft"
                        {% if not proposal.id %}disabled{% endif %}>Reset Draft</button>
            </div>
        </div>

        {% if form.errors %}
            <div class="form-errors-banner">
                <strong>Please fix the following errors:</strong>
                <ul>
                    {% for field, errors in form.errors.items %}
                        {% for error in errors %}
                            <li>{{ field }}: {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                </ul>
            </div>
        {% endif %}

        <form method="post" enctype="multipart/form-data" id="proposal-form" autocomplete="off">
            {% csrf_token %}
            <textarea id="id_need_analysis" name="need_analysis" class="proposal-input" hidden>{{ need_analysis.content|default_if_none:'' }}</textarea>
            <textarea id="id_objectives" name="objectives" class="proposal-input" hidden>{{ objectives.content|default_if_none:'' }}</textarea>
            <textarea id="id_learning_outcomes" name="outcomes" class="proposal-input" hidden>{{ outcomes.content|default_if_none:'' }}</textarea>
            <textarea name="flow" class="proposal-input" hidden>{{ flow.content|default_if_none:'' }}</textarea>
            <div class="ai-actions space-y-2">
              <button type="button" id="btnNeed" class="btn btn-outline-primary">AI: Need Analysis</button>
              <button type="button" id="btnObj" class="btn btn-outline-primary">AI: Objectives</button>
              <button type="button" id="btnOut" class="btn btn-outline-primary">AI: Outcomes + Mapping</button>
              <button type="button" id="btnRpt" class="btn btn-outline-primary">AI: Full Report Draft</button>
            </div>

            <script>
async function postForm(url){
  const form = document.querySelector('form');
  const fd = new FormData(form);
  const resp = await fetch(url, {method:'POST', body: fd});
  if(!resp.ok) throw new Error('AI error');
  return await resp.json();
}

document.getElementById('btnNeed').addEventListener('click', async () => {
  const data = await postForm('{% url "emt:ai_need_analysis" %}');
  document.getElementById('id_need_analysis').value = data.need_analysis || '';
});

document.getElementById('btnObj').addEventListener('click', async () => {
  const data = await postForm('{% url "emt:ai_objectives" %}');
  const area = document.getElementById('id_objectives');
  if(Array.isArray(data.objectives)){
    area.value = data.objectives.map(o => `• ${o.title}: ${o.detail} (Metric: ${o.measurable_metric})`).join('\n');
  }
});

document.getElementById('btnOut').addEventListener('click', async () => {
  const data = await postForm('{% url "emt:ai_outcomes" %}');
  const area = document.getElementById('id_learning_outcomes');
  if(Array.isArray(data.outcomes)){
    area.value = data.outcomes.map(x => `• ${x.statement} | Measure: ${x.measurement} | PSO:${(x.mapped?.PSO||[]).join(',')} PO:${(x.mapped?.PO||[]).join(',')} SDG:${(x.mapped?.SDG||[]).join(',')}`).join('\n');
  }
});

document.getElementById('btnRpt').addEventListener('click', async () => {
  const data = await postForm('{% url "emt:ai_report" %}');
  const preview = document.getElementById('report_preview');
  if(preview){ preview.textContent = data.report_markdown || ''; }
});
            </script>

            <div class="form-panel" id="form-panel">
                <div class="form-panel-content" id="form-panel-content">
                    <div class="form-grid">
                        <!-- Organization Information Section -->
                        <div class="form-section-header">
                            <h3>Organization Details</h3>
                        </div>
                        
                        <div class="form-row full-width">
                            <div class="input-group">
                                <label for="org-type-modern-input">Type of Organisation *</label>
                                <div id="org-type-modern">
                                    <select required>
                                        <option value="">Select Organization Type</option>
                                    </select>
                                </div>
                                <div class="help-text">Choose the type of organization hosting this event</div>
                            </div>
                        </div>

                        <!-- Dynamic organization field will be inserted here -->

                        <div class="form-row full-width">
                            <div class="input-group">
                                <label for="committees-collaborations-modern">Committees & Collaborations</label>
                                <select id="committees-collaborations-modern" multiple placeholder="Type or select organizations..."></select>
                                <div class="help-text">Mention internal committees and external partners involved</div>
                            </div>
                        </div>

                        <!-- Event Information Section -->
                        <div class="form-section-header">
                            <h3>Event Information</h3>
                        </div>

                        <div class="form-row">
                            <div class="input-group">
                                <label for="event-title-modern">Event Title *</label>
                                <input type="text" id="event-title-modern" class="proposal-input" required placeholder="Enter a descriptive event title">
                                <div class="help-text">Provide a clear and engaging title for your event</div>
                            </div>
                            <div class="input-group">
                                <label for="target-audience-modern">Target Audience *</label>
                                <input type="text" id="target-audience-modern" class="proposal-input" required readonly placeholder="Select target audience">
                <input type="hidden" name="target_audience_class_ids" id="target-audience-class-ids" class="proposal-input">
                                <div class="help-text">Specify who this event is intended for</div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="input-group">
                                <label for="event-focus-type-modern">Event Focus Type</label>
                                <input type="text" id="event-focus-type-modern" class="proposal-input" placeholder="Enter event focus">
                                <div class="help-text">Specify the primary focus of your event</div>
                            </div>
                            <div class="input-group">
                                <label for="venue-modern">Location</label>
                                <input type="text" id="venue-modern" class="proposal-input" placeholder="e.g., Main Auditorium, Online">
                                <div class="help-text">Specify where the event will take place</div>
                            </div>
                        </div>
                        
                        <!-- Date and Academic Information Section -->
                        <div class="form-section-header">
                            <h3>Schedule & Academic Information</h3>
                        </div>
                        
                        <div class="form-row">
                            <div class="input-group">
                                <label for="event-start-date">Start Date *</label>
                                <input type="date" id="event-start-date" class="proposal-input" required>
                                <div class="help-text">When does your event begin?</div>
                            </div>
                            <div class="input-group">
                                <label for="event-end-date">End Date *</label>
                                <input type="date" id="event-end-date" class="proposal-input" required>
                                <div class="help-text">When does your event end?</div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="input-group">
                                <label for="academic-year-modern">Academic Year *</label>
                                <input type="text" id="academic-year-modern" class="proposal-input"
                                       value="{{ form.academic_year.value|default:'' }}" disabled>
                                <input type="hidden" name="academic_year" id="academic-year-hidden"
                                       class="proposal-input" value="{{ form.academic_year.value|default:'' }}">
                                <div class="help-text">Academic year for which this event is planned</div>

                            </div>
                            <div class="input-group">
                                <label for="pos-pso-modern">POS & PSO Management</label>
                                <textarea id="pos-pso-modern" name="pos_pso" class="proposal-input" rows="2" placeholder="e.g., PO1, PSO2"></textarea>
                                <div class="help-text">Program outcomes and specific outcomes addressed</div>
                            </div>
                        </div>

                        <!-- SDG Goals Section -->
                        <div class="form-section-header">
                            <h3>SDG Goals</h3>
                        </div>

                        <div class="form-row full-width">
                            <div class="input-group">
                                <label for="sdg-goals-modern">Aligned SDG Goals</label>
                                <input type="text" id="sdg-goals-modern" class="proposal-input" placeholder="Select SDG goals">
                                <div class="help-text">Specify which Sustainable Development Goals this event addresses</div>
                            </div>
                        </div>

                        <!-- Activities Section -->
                        <div class="form-section-header">
                            <h3>Activities Planning</h3>
                        </div>

                        <div class="form-row">
                            <div class="input-group">
                                <label for="num-activities-modern">Number of Activities</label>
                                <input type="number" id="num-activities-modern" name="num_activities" class="proposal-input" min="1" max="50" placeholder="Enter number of activities">
                                <div class="help-text">How many activities will your event include?</div>
                            </div>
                            <div class="input-group">
                                <label for="student-coordinators-modern">Student Coordinators</label>
                                <select id="student-coordinators-modern" class="proposal-input" multiple></select>
                                <div class="help-text">Search and select student coordinators by name</div>
                                <ul id="student-coordinators-list" class="selected-coordinators-list"></ul>
                            </div>
                        </div>

                        <!-- Dynamic activities section -->
                        <div id="dynamic-activities-section" class="full-width"></div>

                        <!-- Faculty Section -->
                        <div class="form-section-header">
                            <h3>Faculty Information</h3>
                        </div>

                        <div class="form-row full-width">
                            <div class="input-group">
                                <label for="faculty-select">Faculty Incharges *</label>
                                <select id="faculty-select" multiple></select>
                                <div class="help-text">Select faculty members who will be in charge of this event</div>
                            </div>
                        </div>
                        
                        <!-- Save Section -->
                        <div class="form-row full-width">
                            <div class="save-section-container" style="display: flex; flex-direction: column; align-items: center;">
                                <button type="button" class="btn-save-section" style="margin-bottom: 0.5rem;">Save & Continue</button>
                                <div class="save-help-text" style="margin-top: 0.75rem;">Complete this section to unlock the next one</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="display: none;" id="django-forms">
                <div id="django-basic-info">
                    {{ form.organization_type.label_tag }}
                    {{ form.organization_type }}
                    {{ form.organization.label_tag }}
                    {{ form.organization }}
                    {{ form.event_title.label_tag }}
                    {{ form.event_title }}
                    {{ form.event_start_date.label_tag }}
                    {{ form.event_start_date }}
                    {{ form.event_end_date.label_tag }}
                    {{ form.event_end_date }}
                    {{ form.venue.label_tag }}
                    {{ form.venue }}
                    {{ form.target_audience.label_tag }}
                    {{ form.target_audience }}
                    {{ form.event_focus_type.label_tag }}
                    {{ form.event_focus_type }}
                    {{ form.pos_pso.label_tag }}
                    {{ form.pos_pso }}
                    {{ form.committees_collaborations.label_tag }}
                    {{ form.committees_collaborations }}
                    <input type="hidden" name="committees_collaborations_ids" id="committees-collaborations-ids" class="proposal-input">
                    {{ form.sdg_goals.label_tag }}
                    {{ form.sdg_goals }}
                    {{ form.student_coordinators.label_tag }}
                    {{ form.student_coordinators }}
                    {{ form.num_activities.label_tag }}
                    {{ form.num_activities }}
                    <div class="input-group">
                        {{ form.faculty_incharges.label_tag }}
                        {{ form.faculty_incharges }}
                    </div>
                    {% for field in form.visible_fields %}
                        {% if field.name not in "organization_type,organization,event_title,event_start_date,event_end_date,venue,target_audience,event_focus_type,academic_year,student_coordinators,num_activities,faculty_incharges,pos_pso,sdg_goals,committees_collaborations" %}
                            <div id="django-field-{{ field.name }}">
                                {{ field.label_tag }}
                                {{ field }}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </form>
    </main>
</div>

<div class="autosave-indicator" id="autosave-indicator">
    <span class="indicator-text">Saved</span>
</div>
{% if proposal.organization %}
<div id="outcomeModal" class="outcome-modal" data-url="{% url 'emt:api_outcomes' proposal.organization.id %}">
    <div class="modal-content">
        <h3>Select Outcomes</h3>
        <div id="outcomeOptions">Loading...</div>
        <div class="modal-actions">
            <button type="button" id="outcomeCancel" class="btn-cancel">Cancel</button>
            <button type="button" id="outcomeSave" class="btn-save">Add</button>
        </div>
    </div>
</div>
{% else %}
<div id="outcomeModal" class="outcome-modal" data-url="">
    <div class="modal-content">
        <h3>Select Outcomes</h3>
        <div id="outcomeOptions">No organization selected.</div>
        <div class="modal-actions">
            <button type="button" id="outcomeCancel" class="btn-cancel">Cancel</button>
            <button type="button" id="outcomeSave" class="btn-save">Add</button>
        </div>
    </div>
</div>
{% endif %}
<div id="audienceModal" class="outcome-modal">
    <div class="modal-content">
        <h3>Select Target Audience</h3>
        <div id="audienceOptions"></div>
        <div class="modal-actions">
            <button type="button" id="audienceCancel" class="btn-cancel">Cancel</button>
            <button type="button" id="audienceConfirm" class="btn-save">Confirm</button>
        </div>
    </div>
</div>
<div id="sdgModal" class="outcome-modal">
    <div class="modal-content">
        <h3>Select SDG Goals</h3>
        <div id="sdgOptions">No goals available.</div>
        <div class="modal-actions">
            <button type="button" id="sdgCancel" class="btn-cancel">Cancel</button>
            <button type="button" id="sdgSave" class="btn-save">Add</button>
        </div>
    </div>
</div>

<div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <p>Saving...</p>
</div>
{% endblock %}

{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script>
        if (!window.jQuery) { document.write("<script src='{% static 'emt/js/jquery-3.7.1.min.js' %}'><\/script>"); }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <script>
        window.PROPOSAL_ID = "{{ proposal.id|default:'' }}";
        window.PROPOSAL_STATUS = "{{ proposal.status|default:'draft' }}";
        window.AUTOSAVE_URL = "{% url 'emt:autosave_proposal' %}";
        window.AUTOSAVE_CSRF = "{{ csrf_token }}";
        window.RESET_DRAFT_URL = "{% url 'emt:reset_proposal_draft' %}";
        window.RESET_DRAFT_REDIRECT_URL = "{% url 'emt:submit_proposal' %}";
        window.API_ORGANIZATIONS = "{% url 'emt:api_organizations' %}";
        window.API_FACULTY = "{% url 'emt:api_faculty' %}";
        window.API_CLASSES_BASE = "{% url 'emt:api_classes' 0 %}".split('0/')[0];
        window.API_OUTCOMES_BASE = "{% url 'emt:api_outcomes' 0 %}".replace(/0\/$/, '');
        window.API_FETCH_LINKEDIN = "{% url 'emt:fetch_linkedin_profile' %}";
        window.SDG_GOALS = {{ sdg_goals_list|safe }};
        window.EXISTING_ACTIVITIES = {{ activities_json|safe }};
        window.EXISTING_SPEAKERS = {{ speakers_json|safe }};
        window.EXISTING_EXPENSES = {{ expenses_json|safe }};
        window.EXISTING_INCOME = {{ income_json|default:'[]'|safe }};
        // window.AI_NEED_URL = "{% url 'emt:generate_need_analysis' %}";
        // window.AI_OBJECTIVES_URL = "{% url 'emt:generate_objectives' %}";
        // window.AI_OUTCOMES_URL = "{% url 'emt:generate_expected_outcomes' %}";
    </script>
    <script src="{% static 'emt/js/autosave_draft.js' %}"></script>
    <script src="{% static 'emt/js/proposal_dashboard.js' %}"></script>
{% endblock %}
